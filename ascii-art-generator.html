function generateAscii() {
    if (!originalImage) return;
    // ...前略...
    const brightness = parseFloat(brightnessControl.value);
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);

    let ascii = '';
    let asciiHTML = '';
    for (let y = 0; y < imgData.height; y += 2) {
        let line = '';
        for (let x = 0; x < imgData.width; x++) {
            const offset = (y * imgData.width + x) * 4;
            const r = imgData.data[offset];
            const g = imgData.data[offset + 1];
            const b = imgData.data[offset + 2];
            const avg = ((r + g + b) / 3) * brightness;
            const charIndex = Math.floor((avg / 255) * (asciiChars.length - 1));
            const char = asciiChars[Math.min(Math.max(charIndex, 0), asciiChars.length - 1)];
            ascii += char;
            if (colorizeControl.checked) {
                line += `<span style="color:rgb(${r},${g},${b})">${char === ' ' ? '&nbsp;' : char}</span>`;
            } else {
                line += char;
            }
        }
        ascii += '\n';
        asciiHTML += line + '<br>';
    }
    if (colorizeControl.checked) {
        asciiDiv.innerHTML = asciiHTML;
    } else {
        asciiDiv.textContent = ascii;
    }
    adjustAsciiWidth();
}
