<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ãƒ•ã‚©ãƒ³ãƒˆè¡¨ç¤ºç¢ºèªãƒ„ãƒ¼ãƒ« - ã‚ãŸãã—ã®é“å…·ç®±</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><text y='18' font-size='18'>ğŸ¨</text></svg>">
    <style>
        * {
            box-sizing: border-box;
        }

```
    :root {
        --font-size-base: clamp(24px, 5vw, 48px);
        --font-size-mobile: clamp(18px, 4vw, 32px);
        --font-size-current: var(--font-size-base);
        --spacing-unit: 1rem;
        --border-radius: 16px;
        --transition-base: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --shadow-soft: 0 4px 20px -2px rgba(0, 0, 0, 0.1);
        --shadow-strong: 0 8px 40px -4px rgba(0, 0, 0, 0.15);
        --backdrop-blur: blur(20px);
    }

    /* ãƒ†ãƒ¼ãƒã‚·ã‚¹ãƒ†ãƒ  */
    body.theme-dark {
        --bg-primary: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
        --bg-secondary: rgba(255, 255, 255, 0.05);
        --bg-glass: rgba(255, 255, 255, 0.08);
        --text-primary: #ffffff;
        --text-secondary: #a0a0a0;
        --accent-primary: #00d4ff;
        --accent-secondary: #0099cc;
        --border-color: rgba(255, 255, 255, 0.12);
        --hover-bg: rgba(255, 255, 255, 0.1);
    }

    body.theme-warm {
        --bg-primary: linear-gradient(135deg, #fdf6e3 0%, #f4e5d3 50%, #e8d5b7 100%);
        --bg-secondary: rgba(139, 69, 19, 0.05);
        --bg-glass: rgba(139, 69, 19, 0.08);
        --text-primary: #2c1810;
        --text-secondary: #8b4513;
        --accent-primary: #d2691e;
        --accent-secondary: #cd853f;
        --border-color: rgba(139, 69, 19, 0.2);
        --hover-bg: rgba(139, 69, 19, 0.1);
    }

    body.theme-nature {
        --bg-primary: linear-gradient(135deg, #e8f5e8 0%, #d4f1d4 50%, #c8e6c9 100%);
        --bg-secondary: rgba(76, 175, 80, 0.05);
        --bg-glass: rgba(76, 175, 80, 0.08);
        --text-primary: #1b5e20;
        --text-secondary: #2e7d32;
        --accent-primary: #4caf50;
        --accent-secondary: #66bb6a;
        --border-color: rgba(76, 175, 80, 0.2);
        --hover-bg: rgba(76, 175, 80, 0.1);
    }

    html, body {
        height: 100vh;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        overflow: hidden;
        transition: var(--transition-base);
    }

    /* ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    #displayArea {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: min(90vw, 1200px);
        max-height: 80vh;
        padding: 2rem;
        background: var(--bg-glass);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        backdrop-filter: var(--backdrop-blur);
        box-shadow: var(--shadow-strong);
        font-size: var(--font-size-current);
        line-height: 1.6;
        outline: none;
        overflow: auto;
        transition: var(--transition-base);
        font-family: 'UserCustomFont', system-ui, sans-serif;
        cursor: text;
        user-select: text;
    }

    #displayArea:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1), var(--shadow-strong);
    }

    #displayArea[contenteditable="true"]:empty:before {
        content: 'ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’ç›´æ¥å…¥åŠ›ãƒ»ç·¨é›†ã§ãã¾ã™';
        color: var(--text-secondary);
        font-style: italic;
        opacity: 0.7;
    }

    /* ç¸¦æ›¸ãå¯¾å¿œ - æ”¹å–„ç‰ˆ */
    #displayArea.vertical-rl {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        width: min(60vw, 800px);
        height: 80vh;
        max-height: none;
        padding: 2rem 3rem;
    }

    /* ãƒ«ãƒ“ã‚¹ã‚¿ã‚¤ãƒ« */
    #displayArea rt {
        font-size: 0.6em;
        color: var(--text-secondary);
    }

    /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
    .floating-toolbar {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 0.5rem;
        background: var(--bg-glass);
        border: 1px solid var(--border-color);
        border-radius: calc(var(--border-radius) * 1.5);
        backdrop-filter: var(--backdrop-blur);
        padding: 0.75rem;
        box-shadow: var(--shadow-strong);
        z-index: 100;
        transition: var(--transition-base);
    }

    .toolbar-btn {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        border: none;
        border-radius: 12px;
        background: transparent;
        color: var(--text-primary);
        font-size: 1.2rem;
        cursor: pointer;
        transition: var(--transition-base);
        overflow: hidden;
    }

    .toolbar-btn::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: var(--hover-bg);
        opacity: 0;
        transition: var(--transition-base);
        transform: scale(0.8);
    }

    .toolbar-btn:hover::before {
        opacity: 1;
        transform: scale(1);
    }

    .toolbar-btn:active {
        transform: scale(0.95);
    }

    .toolbar-btn.active {
        background: var(--accent-primary);
        color: white;
    }

    .toolbar-btn input[type="file"] {
        display: none;
    }

    /* ãƒ‘ãƒãƒ«å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .control-panel {
        position: fixed;
        bottom: 5rem;
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-glass);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        backdrop-filter: var(--backdrop-blur);
        box-shadow: var(--shadow-strong);
        padding: 1.5rem;
        min-width: 320px;
        max-width: 500px;
        display: none;
        flex-direction: column;
        gap: 1rem;
        z-index: 200;
        animation: slideUpFadeIn 0.3s ease-out;
    }

    @keyframes slideUpFadeIn {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(1rem);
        }

        // æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´æ©Ÿèƒ½
        handleFontSizeChange() {
            this.currentFontSize = parseInt(this.elements.fontSizeSlider.value);
            this.updateFontSize();
        }

        adjustFontSize(delta) {
            this.currentFontSize = Math.max(12, Math.min(120, this.currentFontSize + delta));
            this.elements.fontSizeSlider.value = this.currentFontSize;
            this.updateFontSize();
        }

        resetFontSize() {
            this.currentFontSize = 40;
            this.elements.fontSizeSlider.value = this.currentFontSize;
            this.updateFontSize();
        }

        updateFontSize() {
            document.documentElement.style.setProperty('--font-size-current', `${this.currentFontSize}px`);
            this.elements.fontSizeDisplay.textContent = `${this.currentFontSize}px`;
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    .panel-header {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .form-input {
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: var(--transition-base);
    }

    .form-input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.1);
    }

    .btn-primary {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        background: var(--accent-primary);
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition-base);
        position: relative;
        overflow: hidden;
    }

    .btn-primary::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
        transform: translateX(-100%);
        transition: transform 0.5s;
    }

    .btn-primary:hover::before {
        transform: translateX(100%);
    }

    .btn-primary:hover {
        background: var(--accent-secondary);
        transform: translateY(-1px);
        box-shadow: var(--shadow-soft);
    }

    .btn-primary:active {
        transform: translateY(0);
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* åŠ¹æœãƒœã‚¿ãƒ³ã‚°ãƒªãƒƒãƒ‰ */
    .effect-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
    }

    .effect-btn {
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 0.85rem;
        cursor: pointer;
        transition: var(--transition-base);
        text-align: center;
    }

    .effect-btn:hover {
        background: var(--hover-bg);
        border-color: var(--accent-primary);
    }

    .effect-btn.active {
        background: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
    }

    /* 3Dã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    .effect-3d-basic {
        text-shadow: 
            1px 1px 0 #ccc,
            2px 2px 0 #bbb,
            3px 3px 0 #aaa,
            4px 4px 5px rgba(0,0,0,0.3);
    }

    .effect-3d-neon {
        text-shadow: 
            0 0 5px currentColor,
            0 0 10px currentColor,
            0 0 15px currentColor;
    }

    .effect-3d-emboss {
        text-shadow: 
            -1px -1px 0 rgba(255,255,255,0.8),
            1px 1px 0 rgba(0,0,0,0.8);
    }

    .effect-3d-deep {
        text-shadow: 
            1px 1px 0 #ddd,
            2px 2px 0 #ccc,
            3px 3px 0 #bbb,
            4px 4px 0 #aaa,
            5px 5px 0 #999,
            6px 6px 10px rgba(0,0,0,0.4);
    }

    .effect-3d-glow {
        text-shadow: 
            0 0 10px currentColor,
            0 0 20px currentColor,
            0 0 30px currentColor;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ */
    .loading {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
    }

    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--border-color);
        border-top: 2px solid var(--accent-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
        :root {
            --font-size-current: var(--font-size-mobile);
        }

        #displayArea {
            width: 95vw;
            padding: 1.5rem;
            max-height: 75vh;
        }

        #displayArea.vertical-rl {
            width: 85vw;
            height: 75vh;
            padding: 1.5rem 2rem;
        }

        .floating-toolbar {
            bottom: 1rem;
            padding: 0.5rem;
            gap: 0.25rem;
        }

        .toolbar-btn {
            width: 44px;
            height: 44px;
            font-size: 1rem;
        }

        .control-panel {
            bottom: 4rem;
            margin: 0 1rem;
            min-width: auto;
            width: calc(100% - 2rem);
            max-width: none;
        }
    }

    @media (max-width: 480px) {
        .toolbar-btn {
            width: 40px;
            height: 40px;
            font-size: 0.9rem;
        }

        .floating-toolbar {
            flex-wrap: wrap;
            justify-content: center;
            max-width: calc(100vw - 2rem);
        }
    }

    /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ */
    @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }

    /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºæ”¹å–„ */
    .toolbar-btn:focus-visible {
        outline: 2px solid var(--accent-primary);
        outline-offset: 2px;
    }

    .form-input:focus-visible,
    .btn-primary:focus-visible,
    .effect-btn:focus-visible {
        outline: 2px solid var(--accent-primary);
        outline-offset: 2px;
    }
</style>
```

</head>
<body class="theme-dark">
    <!-- ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="displayArea" contenteditable="true" spellcheck="false">
        ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
    </div>

```
<!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
<div class="floating-toolbar">
    <button class="toolbar-btn" id="fontFileBtn" title="ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ" aria-label="ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ">
        <input type="file" id="fontFile" accept=".otf,.ttf,.woff,.woff2" aria-label="ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ">
        ğŸ“
    </button>
    <button class="toolbar-btn" id="fontSizeBtn" title="æ–‡å­—ã‚µã‚¤ã‚ºã‚’èª¿æ•´" aria-label="æ–‡å­—ã‚µã‚¤ã‚ºã‚’èª¿æ•´">ğŸ“</button>
    <button class="toolbar-btn" id="themeBtn" title="ãƒ†ãƒ¼ãƒã‚’åˆ‡ã‚Šæ›¿ãˆ" aria-label="ãƒ†ãƒ¼ãƒã‚’åˆ‡ã‚Šæ›¿ãˆ">ğŸ¨</button>
    <button class="toolbar-btn" id="writingModeBtn" title="ç¸¦æ›¸ã/æ¨ªæ›¸ãã‚’åˆ‡ã‚Šæ›¿ãˆ" aria-label="ç¸¦æ›¸ã/æ¨ªæ›¸ãã‚’åˆ‡ã‚Šæ›¿ãˆ">ç¸¦</button>
    <button class="toolbar-btn" id="opentypeBtn" title="OpenTypeæ©Ÿèƒ½ã‚’è¨­å®š" aria-label="OpenTypeæ©Ÿèƒ½ã‚’è¨­å®š">OT</button>
    <button class="toolbar-btn" id="threeDEffectBtn" title="3Dã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é¸æŠ" aria-label="3Dã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é¸æŠ">âœ¨</button>
    <button class="toolbar-btn" id="wikiBtn" title="Wikipediaè¨˜äº‹ã‚’èª­ã¿è¾¼ã¿" aria-label="Wikipediaè¨˜äº‹ã‚’èª­ã¿è¾¼ã¿">ğŸ“–</button>
</div>

<!-- æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ãƒ‘ãƒãƒ« -->
<div id="fontSizePanel" class="control-panel" role="dialog" aria-labelledby="fontsize-header">
    <div class="panel-header" id="fontsize-header">æ–‡å­—ã‚µã‚¤ã‚º</div>
    <div class="form-group">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
            <button id="fontSizeDecrease" class="btn-primary" style="width: 40px; padding: 0.5rem;">âˆ’</button>
            <input id="fontSizeSlider" type="range" min="12" max="120" value="40" 
                   style="flex: 1; accent-color: var(--accent-primary);">
            <button id="fontSizeIncrease" class="btn-primary" style="width: 40px; padding: 0.5rem;">+</button>
        </div>
        <div style="text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
            <span id="fontSizeDisplay">40px</span>
        </div>
    </div>
    <button id="fontSizeReset" class="btn-primary" style="background: var(--bg-secondary); color: var(--text-primary);">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
</div>

<!-- OpenTypeæ©Ÿèƒ½ãƒ‘ãƒãƒ« -->
<div id="opentypePanel" class="control-panel" role="dialog" aria-labelledby="ot-header">
    <div class="panel-header" id="ot-header">OpenTypeæ©Ÿèƒ½</div>
    <div class="form-group">
        <label class="form-label" for="opentypeInput">æ©Ÿèƒ½åï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
        <input id="opentypeInput" class="form-input" type="text" 
               placeholder="ä¾‹: liga, kern, ss01"
               aria-describedby="ot-help">
        <small id="ot-help" style="color: var(--text-secondary); font-size: 0.8rem;">
            ligaã‚„kernã€swashãªã©ã®OpenTypeæ©Ÿèƒ½ã‚’æŒ‡å®šã§ãã¾ã™
        </small>
    </div>
</div>

<!-- 3Dã‚¨ãƒ•ã‚§ã‚¯ãƒˆé¸æŠãƒ‘ãƒãƒ« -->
<div id="threeDEffectPanel" class="control-panel" role="dialog" aria-labelledby="effect-header">
    <div class="panel-header" id="effect-header">3Dã‚¨ãƒ•ã‚§ã‚¯ãƒˆ</div>
    <div class="effect-grid">
        <button class="effect-btn active" data-effect="none">ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç„¡ã—</button>
        <button class="effect-btn" data-effect="basic">åŸºæœ¬ç«‹ä½“</button>
        <button class="effect-btn" data-effect="neon">ãƒã‚ªãƒ³</button>
        <button class="effect-btn" data-effect="emboss">ã‚¨ãƒ³ãƒœã‚¹</button>
        <button class="effect-btn" data-effect="deep">æ·±ã„ç«‹ä½“</button>
        <button class="effect-btn" data-effect="glow">ã‚°ãƒ­ãƒ¼</button>
    </div>
</div>

<!-- Wikipediaè¨˜äº‹ãƒ‘ãƒãƒ« -->
<div id="wikiPanel" class="control-panel" role="dialog" aria-labelledby="wiki-header">
    <div class="panel-header" id="wiki-header">Wikipediaè¨˜äº‹</div>
    <button id="loadWikipediaBtn" class="btn-primary">ãƒ©ãƒ³ãƒ€ãƒ è¨˜äº‹ã‚’èª­ã¿è¾¼ã¿</button>
    <div id="wikiLoadingMsg" class="loading" style="display: none;">
        <div class="spinner"></div>
        <span>èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
</div>

<script>
    class FontViewer {
        constructor() {
            this.currentFontObjectURL = null;
            this.isVerticalWriting = false;
            this.customFontStyleElement = null;
            this.activeOpenTypeFeatures = '';
            this.isComposing = false;
            this.current3DEffect = 'none';
            this.currentTheme = 0;
            this.themes = ['theme-dark', 'theme-warm', 'theme-nature'];
            this.currentFontSize = 40;
            this.shouldRestoreCaret = true;
            
            this.FONT_FAMILY_NAME = 'UserCustomFont';
            
            this.initializeElements();
            this.setupEventListeners();
            this.updateDisplayArea();
        }

        initializeElements() {
            this.elements = {
                displayArea: document.getElementById('displayArea'),
                fontFile: document.getElementById('fontFile'),
                fontFileBtn: document.getElementById('fontFileBtn'),
                fontSizeBtn: document.getElementById('fontSizeBtn'),
                fontSizePanel: document.getElementById('fontSizePanel'),
                fontSizeSlider: document.getElementById('fontSizeSlider'),
                fontSizeDisplay: document.getElementById('fontSizeDisplay'),
                fontSizeIncrease: document.getElementById('fontSizeIncrease'),
                fontSizeDecrease: document.getElementById('fontSizeDecrease'),
                fontSizeReset: document.getElementById('fontSizeReset'),
                themeBtn: document.getElementById('themeBtn'),
                writingModeBtn: document.getElementById('writingModeBtn'),
                opentypeBtn: document.getElementById('opentypeBtn'),
                opentypePanel: document.getElementById('opentypePanel'),
                opentypeInput: document.getElementById('opentypeInput'),
                threeDEffectBtn: document.getElementById('threeDEffectBtn'),
                threeDEffectPanel: document.getElementById('threeDEffectPanel'),
                wikiBtn: document.getElementById('wikiBtn'),
                wikiPanel: document.getElementById('wikiPanel'),
                loadWikipediaBtn: document.getElementById('loadWikipediaBtn'),
                wikiLoadingMsg: document.getElementById('wikiLoadingMsg')
            };
        }

        setupEventListeners() {
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
            this.elements.fontFile.addEventListener('change', this.handleFontFileSelection.bind(this));
            this.elements.fontFileBtn.addEventListener('click', () => this.elements.fontFile.click());

            // æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´
            this.elements.fontSizeBtn.addEventListener('click', () => this.togglePanel(this.elements.fontSizePanel));
            this.elements.fontSizeSlider.addEventListener('input', this.handleFontSizeChange.bind(this));
            this.elements.fontSizeIncrease.addEventListener('click', () => this.adjustFontSize(4));
            this.elements.fontSizeDecrease.addEventListener('click', () => this.adjustFontSize(-4));
            this.elements.fontSizeReset.addEventListener('click', this.resetFontSize.bind(this));

            // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ
            this.elements.themeBtn.addEventListener('click', this.toggleTheme.bind(this));

            // æ›¸å­—æ–¹å‘åˆ‡ã‚Šæ›¿ãˆ
            this.elements.writingModeBtn.addEventListener('click', this.toggleWritingMode.bind(this));

            // OpenTypeæ©Ÿèƒ½
            this.elements.opentypeBtn.addEventListener('click', () => this.togglePanel(this.elements.opentypePanel));
            this.elements.opentypeInput.addEventListener('input', this.handleOpenTypeInput.bind(this));

            // 3Dã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            this.elements.threeDEffectBtn.addEventListener('click', () => this.togglePanel(this.elements.threeDEffectPanel));
            document.querySelectorAll('.effect-btn').forEach(btn => {
                btn.addEventListener('click', () => this.apply3DEffect(btn.dataset.effect));
            });

            // Wikipedia
            this.elements.wikiBtn.addEventListener('click', () => this.togglePanel(this.elements.wikiPanel));
            this.elements.loadWikipediaBtn.addEventListener('click', this.loadWikipediaText.bind(this));

            // ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†
            this.elements.displayArea.addEventListener('compositionstart', () => { this.isComposing = true; });
            this.elements.displayArea.addEventListener('compositionend', () => {
                this.isComposing = false;
                this.updateDisplayArea();
            });
            this.elements.displayArea.addEventListener('input', () => {
                if (!this.isComposing) {
                    this.updateDisplayArea();
                }
            });

            // ãƒ‘ãƒãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.addEventListener('click', this.handleOutsideClick.bind(this));

            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
            document.addEventListener('keydown', this.handleKeyboard.bind(this));
        }

        toggleTheme() {
            document.body.classList.remove(...this.themes);
            this.currentTheme = (this.currentTheme + 1) % this.themes.length;
            document.body.classList.add(this.themes[this.currentTheme]);
            
            // ãƒœã‚¿ãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            this.elements.themeBtn.style.transform = 'rotate(360deg)';
            setTimeout(() => {
                this.elements.themeBtn.style.transform = '';
            }, 300);
        }

        toggleWritingMode() {
            this.isVerticalWriting = !this.isVerticalWriting;
            this.elements.writingModeBtn.textContent = this.isVerticalWriting ? 'æ¨ª' : 'ç¸¦';
            this.elements.writingModeBtn.classList.toggle('active', this.isVerticalWriting);
            
            // ã‚­ãƒ£ãƒ¬ãƒƒãƒˆä½ç½®å¾©å…ƒã‚’ç„¡åŠ¹åŒ–ã—ã¦æ›¸å­—æ–¹å‘ã‚’æ›´æ–°
            this.shouldRestoreCaret = false;
            this.updateDisplayArea();
            this.shouldRestoreCaret = true;
            
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã—ã¦ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒå‡ºã‚‹ã®ã‚’é˜²ã
            this.elements.displayArea.blur();
            
            // ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼šå°‘ã—é…ã‚‰ã›ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å®Œå…¨ã«å¤–ã™
            setTimeout(() => {
                if (document.activeElement === this.elements.displayArea) {
                    document.activeElement.blur();
                }
            }, 100);
        }

        togglePanel(targetPanel) {
            const panels = [this.elements.fontSizePanel, this.elements.opentypePanel, this.elements.threeDEffectPanel, this.elements.wikiPanel];
            const isCurrentlyOpen = targetPanel.style.display === 'flex';
            
            // å…¨ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
            panels.forEach(panel => panel.style.display = 'none');
            
            // å¯¾è±¡ãƒ‘ãƒãƒ«ã‚’é–‹ãï¼ˆæ—¢ã«é–‹ã„ã¦ã„ãŸå ´åˆã¯é–‰ã˜ã‚‹ï¼‰
            if (!isCurrentlyOpen) {
                targetPanel.style.display = 'flex';
            }
        }

        handleOutsideClick(event) {
            const panels = [this.elements.fontSizePanel, this.elements.opentypePanel, this.elements.threeDEffectPanel, this.elements.wikiPanel];
            const toolbar = document.querySelector('.floating-toolbar');
            
            if (!toolbar.contains(event.target) && !panels.some(panel => panel.contains(event.target))) {
                panels.forEach(panel => panel.style.display = 'none');
            }
        }

        handleKeyboard(event) {
            // Ctrl/Cmd + æ•°å­—ã§ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ
            if ((event.ctrlKey || event.metaKey) && event.key >= '1' && event.key <= '3') {
                event.preventDefault();
                const themeIndex = parseInt(event.key) - 1;
                document.body.classList.remove(...this.themes);
                document.body.classList.add(this.themes[themeIndex]);
                this.currentTheme = themeIndex;
            }
            
            // Ctrl/Cmd + +/- ã§æ–‡å­—ã‚µã‚¤ã‚ºå¤‰æ›´
            if ((event.ctrlKey || event.metaKey) && (event.key === '+' || event.key === '=')) {
                event.preventDefault();
                this.adjustFontSize(4);
            }
            if ((event.ctrlKey || event.metaKey) && event.key === '-') {
                event.preventDefault();
                this.adjustFontSize(-4);
            }
            
            // Escã‚­ãƒ¼ã§ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
            if (event.key === 'Escape') {
                const panels = [this.elements.fontSizePanel, this.elements.opentypePanel, this.elements.threeDEffectPanel, this.elements.wikiPanel];
                panels.forEach(panel => panel.style.display = 'none');
            }
        }

        updateDisplayArea() {
            // ã‚­ãƒ£ãƒ¬ãƒƒãƒˆä½ç½®ä¿å­˜
            const selection = window.getSelection();
            let caretOffset = 0;
            if (this.shouldRestoreCaret && selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(this.elements.displayArea);
                preCaretRange.setEnd(range.endContainer, range.endOffset);
                caretOffset = preCaretRange.toString().length;
            }

            // ãƒ«ãƒ“å¤‰æ›
            const rawText = this.elements.displayArea.innerText || '';
            let htmlContent = rawText ? this.aozoraToRubyHTML(rawText) : '';
            htmlContent = htmlContent.replace(/\n/g, '<br>');
            this.elements.displayArea.innerHTML = htmlContent || '';

            // ã‚­ãƒ£ãƒ¬ãƒƒãƒˆä½ç½®å¾©å…ƒï¼ˆæ›¸å­—æ–¹å‘åˆ‡ã‚Šæ›¿ãˆæ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
            if (this.shouldRestoreCaret && caretOffset > 0) {
                this.setCaretByOffset(this.elements.displayArea, caretOffset);
            }

            // æ›¸å­—æ–¹å‘
            this.elements.displayArea.classList.toggle('vertical-rl', this.isVerticalWriting);

            this.updateOpenTypeFeatures();
        }

        aozoraToRubyHTML(text) {
            return text.replace(/ï½œ([^ã€Šã€‹]+)ã€Š([^ã€‹]+)ã€‹/g, '<ruby>$1<rt>$2</rt></ruby>')
                      .replace(/([ä¸€-é¾¯ã€…]+)ã€Š([^ã€‹]+)ã€‹/g, '<ruby>$1<rt>$2</rt></ruby>');
        }

        setCaretByOffset(element, offset) {
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            let currentOffset = 0;
            let node;
            
            while (node = walker.nextNode()) {
                const nodeLength = node.nodeValue.length;
                if (currentOffset + nodeLength >= offset) {
                    const range = document.createRange();
                    range.setStart(node, offset - currentOffset);
                    range.collapse(true);
                    
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    break;
                }
                currentOffset += nodeLength;
            }
        }

        handleFontFileSelection(event) {
            const file = event.target.files[0];
            
            // æ—¢å­˜ãƒ•ã‚©ãƒ³ãƒˆã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            this.cleanupCurrentFont();

            if (!file) {
                this.showFontError('ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            const allowedExtensions = ['otf', 'ttf', 'woff', 'woff2'];
            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (!allowedExtensions.includes(fileExtension)) {
                this.showFontError('å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚<br>.otf, .ttf, .woff, .woff2 ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            this.loadFont(file);
        }

        cleanupCurrentFont() {
            if (this.currentFontObjectURL) {
                URL.revokeObjectURL(this.currentFontObjectURL);
                this.currentFontObjectURL = null;
            }
            if (this.customFontStyleElement) {
                this.customFontStyleElement.remove();
                this.customFontStyleElement = null;
            }
            this.elements.displayArea.style.fontFamily = '';
        }

        showFontError(message) {
            this.elements.displayArea.innerHTML = `<div style="text-align: center; color: var(--text-secondary); font-style: italic; opacity: 0.8;">${message}</div>`;
        }

        loadFont(file) {
            this.currentFontObjectURL = URL.createObjectURL(file);

            this.customFontStyleElement = document.createElement('style');
            this.customFontStyleElement.textContent = `
                @font-face {
                    font-family: '${this.FONT_FAMILY_NAME}';
                    src: url('${this.currentFontObjectURL}');
                }
            `;
            document.head.appendChild(this.customFontStyleElement);
            
            this.elements.displayArea.style.fontFamily = `'${this.FONT_FAMILY_NAME}', system-ui, sans-serif`;
            this.updateDisplayArea();
        }

        handleOpenTypeInput() {
            this.activeOpenTypeFeatures = this.elements.opentypeInput.value;
            this.updateOpenTypeFeatures();
        }

        updateOpenTypeFeatures() {
            if (!this.activeOpenTypeFeatures) {
                this.elements.displayArea.style.fontFeatureSettings = '';
                this.elements.displayArea.style.webkitFontFeatureSettings = '';
                return;
            }

            const features = this.activeOpenTypeFeatures.split(',')
                .map(f => f.trim())
                .filter(f => f)
                .map(f => /^'.*'$/.test(f) ? f : `'${f}' 1`)
                .join(',');

            this.elements.displayArea.style.fontFeatureSettings = features;
            this.elements.displayArea.style.webkitFontFeatureSettings = features;
        }

        apply3DEffect(effectType) {
            this.current3DEffect = effectType;
            
            // æ—¢å­˜ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤
            const effectClasses = ['effect-3d-basic', 'effect-3d-neon', 'effect-3d-emboss', 'effect-3d-deep', 'effect-3d-glow'];
            this.elements.displayArea.classList.remove(...effectClasses);
            
            // æ–°ã—ã„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é©ç”¨
            if (effectType !== 'none') {
                this.elements.displayArea.classList.add(`effect-3d-${effectType}`);
            }
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³æ›´æ–°
            document.querySelectorAll('.effect-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.effect === effectType);
            });
        }

        async loadWikipediaText() {
            this.elements.wikiLoadingMsg.style.display = 'flex';
            this.elements.loadWikipediaBtn.disabled = true;
            
            try {
                const response = await fetch('https://twitter-proxy.k-e034-twitter-proxy.workers.dev');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Wikipediaè¨˜äº‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ`);
                }
                
                const data = await response.json();
                const title = data.title || 'ç„¡é¡Œ';
                const extract = data.extract || data.content || data.text || 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ';
                
                this.elements.displayArea.innerText = `${title}\n\n${extract}`;
                this.updateDisplayArea();
                this.elements.wikiPanel.style.display = 'none';
                
            } catch (error) {
                console.error('Wikipediaè¨˜äº‹ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('Wikipediaè¨˜äº‹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } finally {
                this.elements.wikiLoadingMsg.style.display = 'none';
                this.elements.loadWikipediaBtn.disabled = false;
            }
        }
    }

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    document.addEventListener('DOMContentLoaded', () => {
        new FontViewer();
    });
</script>
```

</body>
</html>