<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>„Éï„Ç©„É≥„ÉàË°®Á§∫Á¢∫Ë™ç„ÉÑ„Éº„É´ - „Çè„Åü„Åè„Åó„ÅÆÈÅìÂÖ∑ÁÆ±</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><text y='18' font-size='18'>üé®</text></svg>">
    <style>
        * {
            box-sizing: border-box;
        }

```
    :root {
        --font-size-base: clamp(24px, 5vw, 48px);
        --font-size-mobile: clamp(18px, 4vw, 32px);
        --spacing-unit: 1rem;
        --border-radius: 16px;
        --transition-base: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --shadow-soft: 0 4px 20px -2px rgba(0, 0, 0, 0.1);
        --shadow-strong: 0 8px 40px -4px rgba(0, 0, 0, 0.15);
        --backdrop-blur: blur(20px);
    }

    /* „ÉÜ„Éº„Éû„Ç∑„Çπ„ÉÜ„É† */
    body.theme-dark {
        --bg-primary: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
        --bg-secondary: rgba(255, 255, 255, 0.05);
        --bg-glass: rgba(255, 255, 255, 0.08);
        --text-primary: #ffffff;
        --text-secondary: #a0a0a0;
        --accent-primary: #00d4ff;
        --accent-secondary: #0099cc;
        --border-color: rgba(255, 255, 255, 0.12);
        --hover-bg: rgba(255, 255, 255, 0.1);
    }

    body.theme-warm {
        --bg-primary: linear-gradient(135deg, #fdf6e3 0%, #f4e5d3 50%, #e8d5b7 100%);
        --bg-secondary: rgba(139, 69, 19, 0.05);
        --bg-glass: rgba(139, 69, 19, 0.08);
        --text-primary: #2c1810;
        --text-secondary: #8b4513;
        --accent-primary: #d2691e;
        --accent-secondary: #cd853f;
        --border-color: rgba(139, 69, 19, 0.2);
        --hover-bg: rgba(139, 69, 19, 0.1);
    }

    body.theme-nature {
        --bg-primary: linear-gradient(135deg, #e8f5e8 0%, #d4f1d4 50%, #c8e6c9 100%);
        --bg-secondary: rgba(76, 175, 80, 0.05);
        --bg-glass: rgba(76, 175, 80, 0.08);
        --text-primary: #1b5e20;
        --text-secondary: #2e7d32;
        --accent-primary: #4caf50;
        --accent-secondary: #66bb6a;
        --border-color: rgba(76, 175, 80, 0.2);
        --hover-bg: rgba(76, 175, 80, 0.1);
    }

    html, body {
        height: 100vh;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        overflow: hidden;
        transition: var(--transition-base);
    }

    /* „É°„Ç§„É≥Ë°®Á§∫„Ç®„É™„Ç¢ */
    #displayArea {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: min(90vw, 1200px);
        max-height: 80vh;
        padding: 2rem;
        background: var(--bg-glass);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        backdrop-filter: var(--backdrop-blur);
        box-shadow: var(--shadow-strong);
        font-size: var(--font-size-base);
        line-height: 1.6;
        outline: none;
        overflow: auto;
        transition: var(--transition-base);
        font-family: 'UserCustomFont', system-ui, sans-serif;
        cursor: text;
        user-select: text;
    }

    #displayArea:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1), var(--shadow-strong);
    }

    #displayArea[contenteditable="true"]:empty:before {
        content: '„Åì„Åì„Å´„ÉÜ„Ç≠„Çπ„Éà„ÇíÁõ¥Êé•ÂÖ•Âäõ„ÉªÁ∑®ÈõÜ„Åß„Åç„Åæ„Åô';
        color: var(--text-secondary);
        font-style: italic;
        opacity: 0.7;
    }

    /* Á∏¶Êõ∏„ÅçÂØæÂøú - ÊîπÂñÑÁâà */
    #displayArea.vertical-rl {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        width: min(60vw, 800px);
        height: 80vh;
        max-height: none;
        padding: 2rem 3rem;
    }

    /* „É´„Éì„Çπ„Çø„Ç§„É´ */
    #displayArea rt {
        font-size: 0.6em;
        color: var(--text-secondary);
    }

    /* „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„ÉÑ„Éº„É´„Éê„Éº */
    .floating-toolbar {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 0.5rem;
        background: var(--bg-glass);
        border: 1px solid var(--border-color);
        border-radius: calc(var(--border-radius) * 1.5);
        backdrop-filter: var(--backdrop-blur);
        padding: 0.75rem;
        box-shadow: var(--shadow-strong);
        z-index: 100;
        transition: var(--transition-base);
    }

    .toolbar-btn {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        border: none;
        border-radius: 12px;
        background: transparent;
        color: var(--text-primary);
        font-size: 1.2rem;
        cursor: pointer;
        transition: var(--transition-base);
        overflow: hidden;
    }

    .toolbar-btn::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: var(--hover-bg);
        opacity: 0;
        transition: var(--transition-base);
        transform: scale(0.8);
    }

    .toolbar-btn:hover::before {
        opacity: 1;
        transform: scale(1);
    }

    .toolbar-btn:active {
        transform: scale(0.95);
    }

    .toolbar-btn.active {
        background: var(--accent-primary);
        color: white;
    }

    .toolbar-btn input[type="file"] {
        display: none;
    }

    /* „Éë„Éç„É´ÂÖ±ÈÄö„Çπ„Çø„Ç§„É´ */
    .control-panel {
        position: fixed;
        bottom: 5rem;
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-glass);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        backdrop-filter: var(--backdrop-blur);
        box-shadow: var(--shadow-strong);
        padding: 1.5rem;
        min-width: 320px;
        max-width: 500px;
        display: none;
        flex-direction: column;
        gap: 1rem;
        z-index: 200;
        animation: slideUpFadeIn 0.3s ease-out;
    }

    @keyframes slideUpFadeIn {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(1rem);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    .panel-header {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .form-input {
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: var(--transition-base);
    }

    .form-input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.1);
    }

    .btn-primary {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        background: var(--accent-primary);
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition-base);
        position: relative;
        overflow: hidden;
    }

    .btn-primary::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
        transform: translateX(-100%);
        transition: transform 0.5s;
    }

    .btn-primary:hover::before {
        transform: translateX(100%);
    }

    .btn-primary:hover {
        background: var(--accent-secondary);
        transform: translateY(-1px);
        box-shadow: var(--shadow-soft);
    }

    .btn-primary:active {
        transform: translateY(0);
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* ÂäπÊûú„Éú„Çø„É≥„Ç∞„É™„ÉÉ„Éâ */
    .effect-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
    }

    .effect-btn {
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 0.85rem;
        cursor: pointer;
        transition: var(--transition-base);
        text-align: center;
    }

    .effect-btn:hover {
        background: var(--hover-bg);
        border-color: var(--accent-primary);
    }

    .effect-btn.active {
        background: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
    }

    /* ÊñáÂ≠ó„Çµ„Ç§„Ç∫Ë™øÊï¥„Éë„Éç„É´ */
    .font-size-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }

    .font-size-controls button {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 8px;
        background: var(--accent-primary);
        color: white;
        cursor: pointer;
        font-size: 1.2rem;
        transition: var(--transition-base);
    }

    .font-size-controls button:hover {
        background: var(--accent-secondary);
    }

    .font-size-controls input[type="range"] {
        flex: 1;
        accent-color: var(--accent-primary);
    }

    .font-size-display {
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    /* 3D„Ç®„Éï„Çß„ÇØ„Éà */
    .effect-3d-basic {
        text-shadow: 
            1px 1px 0 #ccc,
            2px 2px 0 #bbb,
            3px 3px 0 #aaa,
            4px 4px 5px rgba(0,0,0,0.3);
    }

    .effect-3d-neon {
        text-shadow: 
            0 0 5px currentColor,
            0 0 10px currentColor,
            0 0 15px currentColor;
    }

    .effect-3d-emboss {
        text-shadow: 
            -1px -1px 0 rgba(255,255,255,0.8),
            1px 1px 0 rgba(0,0,0,0.8);
    }

    .effect-3d-deep {
        text-shadow: 
            1px 1px 0 #ddd,
            2px 2px 0 #ccc,
            3px 3px 0 #bbb,
            4px 4px 0 #aaa,
            5px 5px 0 #999,
            6px 6px 10px rgba(0,0,0,0.4);
    }

    .effect-3d-glow {
        text-shadow: 
            0 0 10px currentColor,
            0 0 20px currentColor,
            0 0 30px currentColor;
    }

    /* „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã */
    .loading {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
    }

    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--border-color);
        border-top: 2px solid var(--accent-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
    @media (max-width: 768px) {
        #displayArea {
            width: 95vw;
            padding: 1.5rem;
            font-size: var(--font-size-mobile);
            max-height: 75vh;
        }

        #displayArea.vertical-rl {
            width: 85vw;
            height: 75vh;
            padding: 1.5rem 2rem;
        }

        .floating-toolbar {
            bottom: 1rem;
            padding: 0.5rem;
            gap: 0.25rem;
        }

        .toolbar-btn {
            width: 44px;
            height: 44px;
            font-size: 1rem;
        }

        .control-panel {
            bottom: 4rem;
            margin: 0 1rem;
            min-width: auto;
            width: calc(100% - 2rem);
            max-width: none;
        }
    }

    @media (max-width: 480px) {
        .toolbar-btn {
            width: 40px;
            height: 40px;
            font-size: 0.9rem;
        }

        .floating-toolbar {
            flex-wrap: wrap;
            justify-content: center;
            max-width: calc(100vw - 2rem);
        }
    }

    /* „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£ÂØæÂøú */
    @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }

    /* „Éï„Ç©„Éº„Ç´„ÇπË°®Á§∫ÊîπÂñÑ */
    .toolbar-btn:focus-visible {
        outline: 2px solid var(--accent-primary);
        outline-offset: 2px;
    }

    .form-input:focus-visible,
    .btn-primary:focus-visible,
    .effect-btn:focus-visible {
        outline: 2px solid var(--accent-primary);
        outline-offset: 2px;
    }
</style>
```

</head>
<body class="theme-dark">
    <!-- „É°„Ç§„É≥Ë°®Á§∫„Ç®„É™„Ç¢ -->
    <div id="displayArea" contenteditable="true" spellcheck="false">
        „Åì„Åì„Å´„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
    </div>

```
<!-- „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„ÉÑ„Éº„É´„Éê„Éº -->
<div class="floating-toolbar">
    <button class="toolbar-btn" id="fontFileBtn" title="„Éï„Ç©„É≥„Éà„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû" aria-label="„Éï„Ç©„É≥„Éà„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû">
        <input type="file" id="fontFile" accept=".otf,.ttf,.woff,.woff2" aria-label="„Éï„Ç©„É≥„Éà„Éï„Ç°„Ç§„É´ÈÅ∏Êäû">
        üìÅ
    </button>
    <button class="toolbar-btn" id="fontSizeBtn" title="ÊñáÂ≠ó„Çµ„Ç§„Ç∫„ÇíË™øÊï¥" aria-label="ÊñáÂ≠ó„Çµ„Ç§„Ç∫„ÇíË™øÊï¥">üìè</button>
    <button class="toolbar-btn" id="themeBtn" title="„ÉÜ„Éº„Éû„ÇíÂàá„ÇäÊõø„Åà" aria-label="„ÉÜ„Éº„Éû„ÇíÂàá„ÇäÊõø„Åà">üé®</button>
    <button class="toolbar-btn" id="writingModeBtn" title="Á∏¶Êõ∏„Åç/Ê®™Êõ∏„Åç„ÇíÂàá„ÇäÊõø„Åà" aria-label="Á∏¶Êõ∏„Åç/Ê®™Êõ∏„Åç„ÇíÂàá„ÇäÊõø„Åà">Á∏¶</button>
    <button class="toolbar-btn" id="opentypeBtn" title="OpenTypeÊ©üËÉΩ„ÇíË®≠ÂÆö" aria-label="OpenTypeÊ©üËÉΩ„ÇíË®≠ÂÆö">OT</button>
    <button class="toolbar-btn" id="threeDEffectBtn" title="3D„Ç®„Éï„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû" aria-label="3D„Ç®„Éï„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû">‚ú®</button>
    <button class="toolbar-btn" id="wikiBtn" title="WikipediaË®ò‰∫ã„ÇíË™≠„ÅøËæº„Åø" aria-label="WikipediaË®ò‰∫ã„ÇíË™≠„ÅøËæº„Åø">üìñ</button>
</div>

<!-- ÊñáÂ≠ó„Çµ„Ç§„Ç∫Ë™øÊï¥„Éë„Éç„É´ -->
<div id="fontSizePanel" class="control-panel" role="dialog" aria-labelledby="fontsize-header">
    <div class="panel-header" id="fontsize-header">ÊñáÂ≠ó„Çµ„Ç§„Ç∫</div>
    <div class="form-group">
        <div class="font-size-controls">
            <button id="fontSizeDecrease">‚àí</button>
            <input id="fontSizeSlider" type="range" min="12" max="120" value="40">
            <button id="fontSizeIncrease">+</button>
        </div>
        <div class="font-size-display">
            <span id="fontSizeDisplay">40px</span>
        </div>
    </div>
    <button id="fontSizeReset" class="btn-primary" style="background: var(--bg-secondary); color: var(--text-primary);">„Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô</button>
</div>

<!-- OpenTypeÊ©üËÉΩ„Éë„Éç„É´ -->
<div id="opentypePanel" class="control-panel" role="dialog" aria-labelledby="ot-header">
    <div class="panel-header" id="ot-header">OpenTypeÊ©üËÉΩ</div>
    <div class="form-group">
        <label class="form-label" for="opentypeInput">Ê©üËÉΩÂêçÔºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ</label>
        <input id="opentypeInput" class="form-input" type="text" 
               placeholder="‰æã: liga, kern, ss01"
               aria-describedby="ot-help">
        <small id="ot-help" style="color: var(--text-secondary); font-size: 0.8rem;">
            liga„ÇÑkern„ÄÅswash„Å™„Å©„ÅÆOpenTypeÊ©üËÉΩ„ÇíÊåáÂÆö„Åß„Åç„Åæ„Åô
        </small>
    </div>
</div>

<!-- 3D„Ç®„Éï„Çß„ÇØ„ÉàÈÅ∏Êäû„Éë„Éç„É´ -->
<div id="threeDEffectPanel" class="control-panel" role="dialog" aria-labelledby="effect-header">
    <div class="panel-header" id="effect-header">3D„Ç®„Éï„Çß„ÇØ„Éà</div>
    <div class="effect-grid">
        <button class="effect-btn active" data-effect="none">„Ç®„Éï„Çß„ÇØ„ÉàÁÑ°„Åó</button>
        <button class="effect-btn" data-effect="basic">Âü∫Êú¨Á´ã‰Ωì</button>
        <button class="effect-btn" data-effect="neon">„Éç„Ç™„É≥</button>
        <button class="effect-btn" data-effect="emboss">„Ç®„É≥„Éú„Çπ</button>
        <button class="effect-btn" data-effect="deep">Ê∑±„ÅÑÁ´ã‰Ωì</button>
        <button class="effect-btn" data-effect="glow">„Ç∞„É≠„Éº</button>
    </div>
</div>

<!-- WikipediaË®ò‰∫ã„Éë„Éç„É´ -->
<div id="wikiPanel" class="control-panel" role="dialog" aria-labelledby="wiki-header">
    <div class="panel-header" id="wiki-header">WikipediaË®ò‰∫ã</div>
    <button id="loadWikipediaBtn" class="btn-primary">„É©„É≥„ÉÄ„É†Ë®ò‰∫ã„ÇíË™≠„ÅøËæº„Åø</button>
    <div id="wikiLoadingMsg" class="loading" style="display: none;">
        <div class="spinner"></div>
        <span>Ë™≠„ÅøËæº„Åø‰∏≠...</span>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
    const fontFileInput = document.getElementById('fontFile');
    const fontFileBtn = document.getElementById('fontFileBtn');
    const fontSizeBtn = document.getElementById('fontSizeBtn');
    const fontSizePanel = document.getElementById('fontSizePanel');
    const fontSizeSlider = document.getElementById('fontSizeSlider');
    const fontSizeDisplay = document.getElementById('fontSizeDisplay');
    const fontSizeIncrease = document.getElementById('fontSizeIncrease');
    const fontSizeDecrease = document.getElementById('fontSizeDecrease');
    const fontSizeReset = document.getElementById('fontSizeReset');
    const themeBtn = document.getElementById('themeBtn');
    const writingModeBtn = document.getElementById('writingModeBtn');
    const opentypeBtn = document.getElementById('opentypeBtn');
    const opentypePanel = document.getElementById('opentypePanel');
    const opentypeInput = document.getElementById('opentypeInput');
    const threeDEffectBtn = document.getElementById('threeDEffectBtn');
    const threeDEffectPanel = document.getElementById('threeDEffectPanel');
    const wikiBtn = document.getElementById('wikiBtn');
    const wikiPanel = document.getElementById('wikiPanel');
    const loadWikipediaBtn = document.getElementById('loadWikipediaBtn');
    const wikiLoadingMsg = document.getElementById('wikiLoadingMsg');
    const displayArea = document.getElementById('displayArea');

    // Áä∂ÊÖãÂ§âÊï∞
    let currentFontObjectURL = null;
    let isVerticalWriting = false;
    let customFontStyleElement = null;
    let activeOpenTypeFeatures = '';
    let isComposing = false;
    let current3DEffect = 'none';
    let currentFontSize = 40;
    let shouldRestoreCaret = true;

    const FONT_FAMILY_NAME = 'UserCustomFont';
    const themes = ['theme-dark', 'theme-warm', 'theme-nature'];
    let currentTheme = 0;

    // „Éë„Éç„É´„ÅÆË°®Á§∫ÂàáÊõø
    function togglePanel(targetPanel) {
        const panels = [fontSizePanel, opentypePanel, threeDEffectPanel, wikiPanel];
        const isCurrentlyOpen = targetPanel.style.display === 'flex';
        
        // ÂÖ®„Éë„Éç„É´„ÇíÈñâ„Åò„Çã
        panels.forEach(panel => panel.style.display = 'none');
        
        // ÂØæË±°„Éë„Éç„É´„ÇíÈñã„ÅèÔºàÊó¢„Å´Èñã„ÅÑ„Å¶„ÅÑ„ÅüÂ†¥Âêà„ÅØÈñâ„Åò„ÇãÔºâ
        if (!isCurrentlyOpen) {
            targetPanel.style.display = 'flex';
        }
    }

    // Ë°®Á§∫„Ç®„É™„Ç¢„ÅÆÊõ¥Êñ∞
    function updateDisplayArea() {
        // „Ç≠„É£„É¨„ÉÉ„Éà‰ΩçÁΩÆ‰øùÂ≠ò
        let sel = window.getSelection();
        let caretOffset = 0;
        if (shouldRestoreCaret && sel && sel.rangeCount > 0) {
            let range = sel.getRangeAt(0);
            let preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(displayArea);
            preCaretRange.setEnd(range.endContainer, range.endOffset);
            caretOffset = preCaretRange.toString().length;
        }
        
        // „É´„ÉìÂ§âÊèõ
        let raw = displayArea.innerText || '';
        let html = raw ? aozoraToRubyHTML(raw) : '';
        html = html.replace(/\n/g, '<br>');
        if (!html) html = '';
        displayArea.innerHTML = html;
        
        // „Ç≠„É£„É¨„ÉÉ„Éà‰ΩçÁΩÆÂæ©ÂÖÉÔºàÊõ∏Â≠óÊñπÂêëÂàá„ÇäÊõø„ÅàÊôÇ„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºâ
        if (shouldRestoreCaret && caretOffset > 0) {
            setCaretByOffset(displayArea, caretOffset);
        }
        
        // Êõ∏Â≠óÊñπÂêë
        if (isVerticalWriting) {
            displayArea.classList.add('vertical-rl');
        } else {
            displayArea.classList.remove('vertical-rl');
        }
        
        updateOpenTypeFeatures();
    }

    // „É´„ÉìÂ§âÊèõÔºàÈùíÁ©∫ÊñáÂ∫´Ë®òÊ≥ï„ÇíHTML„É´„Éì„Å´Â§âÊèõÔºâ
    function aozoraToRubyHTML(text) {
        return text.replace(/ÔΩú([^„Ää„Äã]+)„Ää([^„Äã]+)„Äã/g, '<ruby>$1<rt>$2</rt></ruby>')
                  .replace(/([‰∏Ä-ÈæØ„ÄÖ]+)„Ää([^„Äã]+)„Äã/g, '<ruby>$1<rt>$2</rt></ruby>');
    }

    // „Ç≠„É£„É¨„ÉÉ„Éà‰ΩçÁΩÆË®≠ÂÆö
    function setCaretByOffset(node, offset) {
        let stack = [node], count = 0, found = false;
        while (stack.length && !found) {
            let n = stack.shift();
            if (n.nodeType === 3) { // text node
                let len = n.nodeValue.length;
                if (count + len >= offset) {
                    let sel = window.getSelection();
                    let range = document.createRange();
                    range.setStart(n, offset - count);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                    found = true;
                    break;
                }
                count += len;
            } else if (n.childNodes && n.childNodes.length) {
                for (let i = 0; i < n.childNodes.length; i++) stack.push(n.childNodes[i]);
            }
        }
    }

    // „Éï„Ç©„É≥„Éà„Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÂá¶ÁêÜ
    function handleFontFileSelection(event) {
        const file = event.target.files[0];
        
        // Êó¢Â≠ò„Éï„Ç©„É≥„Éà„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        if (currentFontObjectURL) {
            URL.revokeObjectURL(currentFontObjectURL);
            currentFontObjectURL = null;
        }
        if (customFontStyleElement) {
            customFontStyleElement.remove();
            customFontStyleElement = null;
        }
        displayArea.style.fontFamily = '';

        if (!file) {
            displayArea.innerHTML = `<div style="text-align: center; color: var(--text-secondary); font-style: italic; opacity: 0.8;">„Éï„Ç©„É≥„Éà„Éï„Ç°„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</div>`;
            return;
        }

        const allowedTypes = ['font/otf', 'font/ttf', 'font/woff', 'font/woff2'];
        const fileExtension = file.name.split('.').pop().toLowerCase();
        const knownExtensions = ['otf', 'ttf', 'woff', 'woff2'];

        if (!allowedTypes.includes(file.type) && !knownExtensions.includes(fileExtension)) {
            displayArea.innerHTML = `<div style="text-align: center; color: var(--text-secondary); font-style: italic; opacity: 0.8;">„Ç®„É©„Éº: .otf, .ttf, .woff, .woff2 ÂΩ¢Âºè„ÅÆ<br>„Éï„Ç©„É≥„Éà„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>`;
            return;
        }

        currentFontObjectURL = URL.createObjectURL(file);

        customFontStyleElement = document.createElement('style');
        customFontStyleElement.textContent = `
            @font-face {
                font-family: '${FONT_FAMILY_NAME}';
                src: url('${currentFontObjectURL}');
            }
        `;
        document.head.appendChild(customFontStyleElement);
        
        displayArea.style.fontFamily = `'${FONT_FAMILY_NAME}', system-ui, sans-serif`;
        updateDisplayArea();
    }

    // ÊñáÂ≠ó„Çµ„Ç§„Ç∫Ë™øÊï¥
    function updateFontSize() {
        displayArea.style.fontSize = currentFontSize + 'px';
        fontSizeDisplay.textContent = currentFontSize + 'px';
    }

    function adjustFontSize(delta) {
        currentFontSize = Math.max(12, Math.min(120, currentFontSize + delta));
        fontSizeSlider.value = currentFontSize;
        updateFontSize();
    }

    // OpenTypeÊ©üËÉΩ„ÅÆÂèçÊò†
    function updateOpenTypeFeatures() {
        let feat = activeOpenTypeFeatures.split(',')
            .map(f => f.trim())
            .filter(f => f)
            .map(f => /^'.*'$/.test(f) ? f : `'${f}' 1`)
            .join(',');
        displayArea.style.fontFeatureSettings = feat;
        displayArea.style.webkitFontFeatureSettings = feat;
    }

    // 3D„Ç®„Éï„Çß„ÇØ„Éà„ÅÆÈÅ©Áî®
    function apply3DEffect(effectType) {
        current3DEffect = effectType;
        
        // Êó¢Â≠ò„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà„ÇØ„É©„Çπ„ÇíÂâäÈô§
        displayArea.classList.remove('effect-3d-basic', 'effect-3d-neon', 'effect-3d-emboss', 'effect-3d-deep', 'effect-3d-glow');
        
        // Êñ∞„Åó„ÅÑ„Ç®„Éï„Çß„ÇØ„Éà„ÇíÈÅ©Áî®
        if (effectType !== 'none') {
            displayArea.classList.add(`effect-3d-${effectType}`);
        }
        
        // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éú„Çø„É≥„ÅÆÊõ¥Êñ∞
        document.querySelectorAll('.effect-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.effect === effectType) {
                btn.classList.add('active');
            }
        });
    }

    // WikipediaË®ò‰∫ãË™≠„ÅøËæº„Åø
    async function loadWikipediaText() {
        wikiLoadingMsg.style.display = 'flex';
        loadWikipediaBtn.disabled = true;
        
        try {
            const wikiUrl = 'https://twitter-proxy.k-e034-twitter-proxy.workers.dev';
            const res = await fetch(wikiUrl);
            
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: WikipediaË®ò‰∫ã„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü`);
            }
            
            const data = await res.json();
            const title = data.title || 'ÁÑ°È°å';
            const extract = data.extract || data.content || data.text || '„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü';
            
            displayArea.innerText = `${title}\n\n${extract}`;
            updateDisplayArea();
            wikiPanel.style.display = 'none';
            
        } catch (e) {
            console.error('WikipediaË®ò‰∫ã„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
            let errorMsg = 'WikipediaË®ò‰∫ã„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ';
            if (e.name === 'TypeError' && e.message.includes('fetch')) {
                errorMsg += '\n„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
            } else if (e.message.includes('HTTP')) {
                errorMsg += '\n„Çµ„Éº„Éê„Éº„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ';
            } else {
                errorMsg += `\nË©≥Á¥∞: ${e.message}`;
            }
            alert(errorMsg);
        } finally {
            wikiLoadingMsg.style.display = 'none';
            loadWikipediaBtn.disabled = false;
        }
    }

    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
    // „Éï„Ç©„É≥„Éà„Éï„Ç°„Ç§„É´ÈÅ∏Êäû
    fontFileInput.addEventListener('change', handleFontFileSelection);
    fontFileBtn.addEventListener('click', () => fontFileInput.click());
    
    // ÊñáÂ≠ó„Çµ„Ç§„Ç∫Ë™øÊï¥
    fontSizeBtn.addEventListener('click', () => togglePanel(fontSizePanel));
    fontSizeSlider.addEventListener('input', () => {
        currentFontSize = parseInt(fontSizeSlider.value);
        updateFontSize();
    });
    fontSizeIncrease.addEventListener('click', () => adjustFontSize(4));
    fontSizeDecrease.addEventListener('click', () => adjustFontSize(-4));
    fontSizeReset.addEventListener('click', () => {
        currentFontSize = 40;
        fontSizeSlider.value = currentFontSize;
        updateFontSize();
    });
    
    // „ÉÜ„Éº„ÉûÂàáÊõø
    themeBtn.addEventListener('click', () => {
        document.body.classList.remove(...themes);
        currentTheme = (currentTheme + 1) % themes.length;
        document.body.classList.add(themes[currentTheme]);
        
        // „Éú„Çø„É≥„Ç®„Éï„Çß„ÇØ„Éà
        themeBtn.style.transform = 'rotate(360deg)';
        setTimeout(() => {
            themeBtn.style.transform = '';
        }, 300);
    });
    
    // Á∏¶Êõ∏„Åç/Ê®™Êõ∏„ÅçÂàáÊõøÔºà‰øÆÊ≠£ÁâàÔºâ
    writingModeBtn.addEventListener('click', () => {
        isVerticalWriting = !isVerticalWriting;
        writingModeBtn.textContent = isVerticalWriting ? 'Ê®™' : 'Á∏¶';
        writingModeBtn.classList.toggle('active', isVerticalWriting);
        
        // „Ç≠„É£„É¨„ÉÉ„Éà‰ΩçÁΩÆÂæ©ÂÖÉ„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶Êõ∏Â≠óÊñπÂêë„ÇíÊõ¥Êñ∞
        shouldRestoreCaret = false;
        updateDisplayArea();
        shouldRestoreCaret = true;
        
        // „Éï„Ç©„Éº„Ç´„Çπ„ÇíÂ§ñ„Åó„Å¶„Ç≠„Éº„Éú„Éº„Éâ„ÅåÂá∫„Çã„ÅÆ„ÇíÈò≤„Åê
        displayArea.blur();
        
        // „É¢„Éê„Ç§„É´ÂØæÂøúÔºöÂ∞ë„ÅóÈÅÖ„Çâ„Åõ„Å¶„Éï„Ç©„Éº„Ç´„Çπ„ÇíÂÆåÂÖ®„Å´Â§ñ„Åô
        setTimeout(() => {
            if (document.activeElement === displayArea) {
                document.activeElement.blur();
            }
        }, 100);
    });
    
    // OpenTypeÊ©üËÉΩ„Éë„Éç„É´
    opentypeBtn.addEventListener('click', () => {
        togglePanel(opentypePanel);
    });
    opentypeInput.addEventListener('input', () => {
        activeOpenTypeFeatures = opentypeInput.value;
        updateOpenTypeFeatures();
    });
    
    // 3D„Ç®„Éï„Çß„ÇØ„Éà„Éë„Éç„É´
    threeDEffectBtn.addEventListener('click', () => {
        togglePanel(threeDEffectPanel);
    });
    
    // 3D„Ç®„Éï„Çß„ÇØ„Éà„Éú„Çø„É≥
    document.querySelectorAll('.effect-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            apply3DEffect(btn.dataset.effect);
        });
    });
    
    // WikipediaË®ò‰∫ã„Éë„Éç„É´
    wikiBtn.addEventListener('click', () => {
        togglePanel(wikiPanel);
    });
    loadWikipediaBtn.addEventListener('click', loadWikipediaText);
    
    // „ÉÜ„Ç≠„Çπ„ÉàÁ∑®ÈõÜÂØæÂøú
    displayArea.addEventListener('compositionstart', () => { isComposing = true; });
    displayArea.addEventListener('compositionend', () => {
        isComposing = false;
        updateDisplayArea();
    });
    displayArea.addEventListener('input', () => {
        if (!isComposing) {
            updateDisplayArea();
        }
    });
    
    // „Éë„Éç„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    document.addEventListener('click', (event) => {
        const panels = [fontSizePanel, opentypePanel, threeDEffectPanel, wikiPanel];
        const toolbar = document.querySelector('.floating-toolbar');
        
        if (!toolbar.contains(event.target) && !panels.some(panel => panel.contains(event.target))) {
            panels.forEach(panel => panel.style.display = 'none');
        }
    });

    // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
    document.addEventListener('keydown', (event) => {
        // Ctrl/Cmd + Êï∞Â≠ó„Åß„ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà
        if ((event.ctrlKey || event.metaKey) && event.key >= '1' && event.key <= '3') {
            event.preventDefault();
            const themeIndex = parseInt(event.key) - 1;
            document.body.classList.remove(...themes);
            document.body.classList.add(themes[themeIndex]);
            currentTheme = themeIndex;
        }
        
        // Ctrl/Cmd + +/- „ÅßÊñáÂ≠ó„Çµ„Ç§„Ç∫Â§âÊõ¥
        if ((event.ctrlKey || event.metaKey) && (event.key === '+' || event.key === '=')) {
            event.preventDefault();
            adjustFontSize(4);
        }
        if ((event.ctrlKey || event.metaKey) && event.key === '-') {
            event.preventDefault();
            adjustFontSize(-4);
        }
        
        // Esc„Ç≠„Éº„Åß„Éë„Éç„É´„ÇíÈñâ„Åò„Çã
        if (event.key === 'Escape') {
            const panels = [fontSizePanel, opentypePanel, threeDEffectPanel, wikiPanel];
            panels.forEach(panel => panel.style.display = 'none');
        }
    });

    // ÂàùÊúüÂåñ
    updateDisplayArea();
    updateFontSize();
});
</script>
```

</body>
</html>