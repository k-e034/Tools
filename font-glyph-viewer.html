<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>フォントグリフビューア</title>
    <script src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 30px; text-align: center; }
        .header h1 { font-size: 2.8em; margin-bottom: 12px; font-weight: 700; }
        .upload-area { margin: 50px 60px; padding: 80px 40px; border: 3px dashed #667eea; border-radius: 16px; text-align: center; background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%); transition: all 0.3s; }
        .upload-area:hover { background: linear-gradient(135deg, #f0f2ff 0%, #e8ebff 100%); border-color: #764ba2; transform: translateY(-2px); box-shadow: 0 8px 24px rgba(102,126,234,0.2); }
        .upload-icon { font-size: 5em; margin-bottom: 20px; opacity: 0.8; }
        .upload-area h2 { color: #667eea; font-size: 1.8em; margin-bottom: 12px; font-weight: 600; }
        .file-input-label { display: inline-block; padding: 16px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 30px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        .file-input-label:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.6); }
        #fileInput { position: absolute; width: 1px; height: 1px; opacity: 0; overflow: hidden; }
        .loading { text-align: center; padding: 60px 40px; color: #667eea; display: none; font-size: 1.3em; font-weight: 600; }
        .loading.active { display: block; }
        .info-panel { margin: 30px 60px; padding: 30px; background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%); border-radius: 12px; display: none; }
        .info-panel.active { display: block; }
        .info-item { display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid rgba(102,126,234,0.1); }
        .info-label { font-weight: 600; color: #667eea; }
        .stats { display: flex; justify-content: space-around; margin: 30px 60px; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: none; }
        .stats.active { display: flex; }
        .stat-item { text-align: center; color: white; }
        .stat-number { font-size: 3em; font-weight: 700; margin-bottom: 8px; }
        .controls { margin: 30px 60px; padding: 30px; background: white; border-radius: 12px; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .controls.active { display: block; }
        .control-group { margin-bottom: 25px; }
        .control-group label { display: block; font-weight: 600; color: #667eea; margin-bottom: 10px; font-size: 1.05em; }
        .control-group input[type="range"] { width: 100%; }
        .control-group input[type="text"] { width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; }
        .glyph-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 18px; margin: 30px 60px 60px; display: none; }
        .glyph-grid.active { display: grid; }
        .glyph-card { background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .glyph-card:hover { border-color: #667eea; transform: translateY(-4px); box-shadow: 0 8px 16px rgba(102,126,234,0.3); }
        .glyph-display { height: 80px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
        .glyph-info { font-size: 0.85em; color: #666; border-top: 1px solid #e0e0e0; padding-top: 10px; }
        .glyph-unicode { font-weight: 600; color: #667eea; margin-bottom: 4px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; border-radius: 20px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 35px; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; font-size: 2em; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; transition: all 0.3s; }
        .modal-close:hover { background: rgba(255,255,255,0.3); }
        .modal-body { padding: 35px; }
        .glyph-detail-display { background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%); border-radius: 12px; padding: 50px; margin-bottom: 30px; display: flex; align-items: center; justify-content: center; min-height: 400px; }
        .glyph-canvas { border: 2px solid #e0e0e0; background: white; border-radius: 8px; }
        .modal-controls { background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 25px; margin-bottom: 25px; }
        .checkbox-label { display: flex; align-items: center; cursor: pointer; font-weight: 600; color: #667eea; }
        .checkbox-label input { width: 22px; height: 22px; margin-right: 12px; cursor: pointer; }
        .modal-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px; }
        .modal-info-item { background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%); padding: 18px; border-radius: 10px; border-left: 4px solid #667eea; }
        .modal-info-label { font-size: 0.9em; color: #666; margin-bottom: 6px; }
        .modal-info-value { font-size: 1.25em; font-weight: 600; color: #333; word-break: break-word; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔤 フォントグリフビューア</h1>
            <p>cmapテーブルを参照して全グリフを表示</p>
        </div>
        <div class="upload-area">
            <div class="upload-icon">📁</div>
            <h2>フォントファイルを選択</h2>
            <p style="color:#666;margin-bottom:25px;">TTF、OTF、WOFFファイルに対応</p>
            <label for="fileInput" class="file-input-label">ファイルを選択</label>
            <input type="file" id="fileInput" accept=".ttf,.otf,.woff,.woff2">
        </div>
        <div class="loading" id="loading">📊 フォントを解析中...</div>
        <div class="info-panel" id="infoPanel">
            <h3 style="color:#667eea;margin-bottom:20px;">📋 フォント情報</h3>
            <div id="fontInfo"></div>
        </div>
        <div class="stats" id="stats">
            <div class="stat-item"><div class="stat-number" id="totalGlyphs">0</div><div>総グリフ数</div></div>
            <div class="stat-item"><div class="stat-number" id="unicodeGlyphs">0</div><div>Unicode対応</div></div>
        </div>
        <div class="controls" id="controls">
            <div class="control-group">
                <label>グリフサイズ: <span id="sizeValue">48px</span></label>
                <input type="range" id="glyphSize" min="24" max="128" value="48" step="4">
            </div>
            <div class="control-group">
                <label>検索 (Unicode、グリフ名)</label>
                <input type="text" id="searchBox" placeholder="例: U+0041, A, circle">
            </div>
        </div>
        <div class="glyph-grid" id="glyphGrid"></div>
    </div>
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">グリフ詳細</h2>
                <button class="modal-close" id="modalClose">×</button>
            </div>
            <div class="modal-body">
                <div class="glyph-detail-display">
                    <canvas id="glyphCanvas" class="glyph-canvas"></canvas>
                </div>
                <div class="modal-controls">
                    <label class="checkbox-label">
                        <input type="checkbox" id="metricsMode">メトリクスモード
                    </label>
                    <div class="control-group" style="margin-top:20px;">
                        <label>表示サイズ: <span id="modalSizeValue">256px</span></label>
                        <input type="range" id="modalGlyphSize" min="128" max="512" value="256" step="16">
                    </div>
                </div>
                <div class="modal-info" id="modalInfo"></div>
            </div>
        </div>
    </div>
    <script>
        function pad(s,l,c){s=String(s);var i=-1;if(!c&&c!==0)c=' ';l=l-s.length;while(++i<l)s=c+s;return s;}
        var font=null,all=[],filt=[],cur=null;
        document.getElementById('fileInput').onchange=function(e){
            var f=e.target.files[0];if(!f)return;
            document.getElementById('loading').classList.add('active');
            document.querySelector('.upload-area').style.display='none';
            var r=new FileReader();
            r.onload=function(e){
                try{
                    font=opentype.parse(e.target.result);
                    showInfo();extract();render();
                    document.getElementById('loading').classList.remove('active');
                    ['infoPanel','stats','controls','glyphGrid'].forEach(function(id){
                        document.getElementById(id).classList.add('active');
                    });
                }catch(err){alert('エラー: '+err.message);
                    document.getElementById('loading').classList.remove('active');
                    document.querySelector('.upload-area').style.display='block';}
            };r.readAsArrayBuffer(f);
        };
        function showInfo(){
            var n=font.names,h='';
            h+='<div class="info-item"><span class="info-label">フォント名</span><span>'+(n.fullName?n.fullName.en||n.fullName:'N/A')+'</span></div>';
            h+='<div class="info-item"><span class="info-label">グリフ数</span><span>'+font.numGlyphs+'</span></div>';
            h+='<div class="info-item"><span class="info-label">Units per EM</span><span>'+font.unitsPerEm+'</span></div>';
            h+='<div class="info-item"><span class="info-label">Ascender</span><span>'+font.ascender+'</span></div>';
            h+='<div class="info-item"><span class="info-label">Descender</span><span>'+font.descender+'</span></div>';
            document.getElementById('fontInfo').innerHTML=h;
        }
        function extract(){
            all=[];var m={};
            if(font.tables.cmap&&font.tables.cmap.glyphIndexMap){
                for(var c in font.tables.cmap.glyphIndexMap)
                    if(font.tables.cmap.glyphIndexMap.hasOwnProperty(c))
                        m[font.tables.cmap.glyphIndexMap[c]]=parseInt(c,10);
            }
            for(var i=0;i<font.numGlyphs;i++){
                var g=font.glyphs.get(i),u=m[i],h='N/A';
                if(u){var x=u.toString(16).toUpperCase();h='U+'+pad(x,4,'0');}
                all.push({idx:i,g:g,u:u,hex:h,chr:u?String.fromCharCode(u):'',nm:g.name||'glyph'+i});
            }
            filt=all.slice();
            document.getElementById('totalGlyphs').textContent=all.length;
            var uc=0;for(var i=0;i<all.length;i++)if(all[i].u)uc++;
            document.getElementById('unicodeGlyphs').textContent=uc;
        }
        function render(){
            var sz=parseInt(document.getElementById('glyphSize').value,10);
            document.getElementById('sizeValue').textContent=sz+'px';
            var h='',em=font.unitsPerEm,asc=font.ascender,dsc=font.descender,sc=sz/em;
            var vx=0,vy=-asc*sc,vw=em*sc,vh=(asc-dsc)*sc;
            for(var i=0;i<filt.length;i++){
                var it=filt[i],p=it.g.getPath(0,0,sz),sv=p.toSVG(2);
                h+='<div class="glyph-card" onclick="openModal('+i+')">';
                h+='<div class="glyph-display"><svg width="'+sz+'" height="'+sz+'" viewBox="'+vx+' '+vy+' '+vw+' '+vh+'">'+sv+'</svg></div>';
                h+='<div class="glyph-info"><div class="glyph-unicode">'+it.hex+'</div><div>'+(it.chr||it.nm)+'</div></div></div>';
            }
            document.getElementById('glyphGrid').innerHTML=h;
        }
        function openModal(i){
            var gd=filt[i];cur=gd;
            document.getElementById('modalTitle').textContent=gd.hex+' - '+gd.nm;
            var bb=gd.g.getBoundingBox(),h='';
            h+='<div class="modal-info-item"><div class="modal-info-label">Unicode</div><div class="modal-info-value">'+gd.hex+'</div></div>';
            h+='<div class="modal-info-item"><div class="modal-info-label">グリフ名</div><div class="modal-info-value">'+gd.nm+'</div></div>';
            h+='<div class="modal-info-item"><div class="modal-info-label">インデックス</div><div class="modal-info-value">'+gd.idx+'</div></div>';
            h+='<div class="modal-info-item"><div class="modal-info-label">幅</div><div class="modal-info-value">'+(gd.g.advanceWidth||0)+'</div></div>';
            document.getElementById('modalInfo').innerHTML=h;
            drawCanvas();
            document.getElementById('modalOverlay').classList.add('active');
        }
        function drawCanvas(){
            if(!cur)return;
            var sz=parseInt(document.getElementById('modalGlyphSize').value,10);
            document.getElementById('modalSizeValue').textContent=sz+'px';
            var g=cur.g,em=font.unitsPerEm,asc=font.ascender,dsc=font.descender,sc=sz/em,pd=100;
            var c=document.getElementById('glyphCanvas');
            c.width=em*sc+pd*2;c.height=(asc-dsc)*sc+pd*2;
            var ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);
            var p=g.getPath(0,0,em);ctx.save();ctx.translate(pd,pd);ctx.scale(sc,sc);ctx.translate(0,asc);ctx.scale(1,-1);
            ctx.fillStyle='#333';ctx.beginPath();
            for(var i=0;i<p.commands.length;i++){
                var cm=p.commands[i];
                if(cm.type==='M')ctx.moveTo(cm.x,cm.y);
                else if(cm.type==='L')ctx.lineTo(cm.x,cm.y);
                else if(cm.type==='Q')ctx.quadraticCurveTo(cm.x1,cm.y1,cm.x,cm.y);
                else if(cm.type==='C')ctx.bezierCurveTo(cm.x1,cm.y1,cm.x2,cm.y2,cm.x,cm.y);
                else if(cm.type==='Z')ctx.closePath();
            }
            ctx.fill();ctx.restore();
        }
        document.getElementById('glyphSize').oninput=render;
        document.getElementById('searchBox').oninput=function(){
            var q=this.value.toLowerCase();
            if(q){filt=[];for(var i=0;i<all.length;i++){
                var it=all[i];
                if(it.hex.toLowerCase().indexOf(q)>=0||it.nm.toLowerCase().indexOf(q)>=0||it.chr.indexOf(q)>=0)filt.push(it);
            }}else filt=all.slice();
            render();
        };
        document.getElementById('modalClose').onclick=function(){document.getElementById('modalOverlay').classList.remove('active');};
        document.getElementById('modalOverlay').onclick=function(e){if(e.target.id==='modalOverlay')document.getElementById('modalOverlay').classList.remove('active');};
        document.getElementById('metricsMode').onchange=drawCanvas;
        document.getElementById('modalGlyphSize').oninput=drawCanvas;
        document.onkeydown=function(e){if(e.key==='Escape'&&document.getElementById('modalOverlay').classList.contains('active'))document.getElementById('modalOverlay').classList.remove('active');};
    </script>
</body>
</html>