<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIRIBI - TYPOGRAPHY LAB</title>
    <script src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho+B1&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #0f0f0f;
            --line-color: #333;
            --text-color: #e0e0e0;
            --accent-color: #ffffff;
            --dim-color: #666;
            --guide-color: #00ffcc;
            --main-font: 'Shippori Mincho B1', serif;
            --ui-font: 'Roboto Mono', monospace;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--main-font);
            font-synthesis: none;
            overflow-x: hidden;
        }

        /* --- UI Utility & Typography --- */
        .ui-mono { font-family: var(--ui-font); font-size: 0.8rem; letter-spacing: 0.05em; }
        .dim { color: var(--dim-color); }
        h1, h2, h3 { margin: 0; font-weight: normal; }

        /* --- Header Section --- */
        header {
            border-bottom: 1px solid var(--line-color);
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .brand { font-size: 2rem; letter-spacing: 0.1em; }
        .subtitle { display: block; margin-top: 0.5rem; font-size: 0.8rem; color: var(--dim-color); }

        /* --- Upload Area (Drop Zone) --- */
        .upload-section {
            padding: 4rem 2rem;
            border-bottom: 1px solid var(--line-color);
            text-align: center;
        }
        .drop-zone {
            border: 1px dashed var(--line-color);
            background: rgba(255,255,255,0.02);
            padding: 4rem;
            max-width: 600px;
            margin: 0 auto;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        .drop-zone:hover {
            border-color: var(--text-color);
            background: rgba(255,255,255,0.05);
        }
        .drop-zone.active { /* ドラッグ中 */
            border-color: var(--guide-color);
            background: rgba(0, 255, 204, 0.05);
        }
        
        #fileInput { display: none; }
        .btn-upload {
            display: inline-block;
            margin-top: 1.5rem;
            padding: 0.8em 2em;
            background: var(--text-color);
            color: var(--bg-color);
            font-family: var(--ui-font);
            font-weight: bold;
            text-decoration: none;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        .btn-upload:hover { opacity: 0.8; }

        /* --- Control & Info Bar --- */
        .dashboard-bar {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            border-bottom: 1px solid var(--line-color);
            background: var(--bg-color);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .dash-item {
            padding: 1rem 1.5rem;
            border-right: 1px solid var(--line-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .dash-label { font-size: 0.7rem; color: var(--dim-color); margin-bottom: 0.3rem; }
        .dash-value { font-family: var(--ui-font); font-size: 1rem; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .controls-area {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        input[type="range"] {
            -webkit-appearance: none;
            background: #333;
            height: 2px;
            width: 100px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px; height: 12px; background: #fff; border-radius: 50%; cursor: pointer;
        }
        input[type="text"] {
            background: transparent;
            border: 1px solid #333;
            color: #fff;
            padding: 0.5em;
            font-family: var(--ui-font);
            width: 150px;
        }
        input[type="text"]:focus { border-color: #fff; }

        /* --- Glyph Grid --- */
        .glyph-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            border-bottom: 1px solid var(--line-color);
            min-height: 50vh;
        }
        .glyph-cell {
            aspect-ratio: 1;
            border-right: 1px solid var(--line-color);
            border-bottom: 1px solid var(--line-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            overflow: hidden;
        }
        .glyph-cell:hover {
            background: var(--text-color);
            color: var(--bg-color);
            z-index: 2;
            outline: 2px solid var(--guide-color);
        }
        .glyph-svg path {
            fill: currentColor;
        }
        .g-meta {
            position: absolute;
            bottom: 4px;
            left: 4px;
            font-size: 0.6rem;
            font-family: var(--ui-font);
            opacity: 0.5;
        }

        /* --- Modal (Microscope View) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .modal-window {
            width: 90vw;
            max-width: 1000px;
            height: 85vh;
            background: var(--panel-bg);
            border: 1px solid var(--line-color);
            display: grid;
            grid-template-columns: 2fr 1fr;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        .modal-visual {
            position: relative;
            background-color: #080808;
            background-image: 
                linear-gradient(var(--line-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--line-color) 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: center center;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid var(--line-color);
            overflow: hidden;
        }
        canvas { 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            max-width: 100%;
            max-height: 100%;
        }

        .modal-sidebar {
            padding: 2rem;
            overflow-y: auto;
            font-family: var(--ui-font);
        }
        .modal-header {
            border-bottom: 1px solid var(--line-color);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .glyph-large-title { font-size: 2rem; margin-bottom: 0.5rem; font-family: var(--main-font); }
        .close-btn {
            background: none; border: 1px solid var(--dim-color); color: var(--text-color);
            width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .close-btn:hover { background: var(--text-color); color: var(--bg-color); }

        .metric-row {
            display: flex; justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid #222;
        }
        .metric-label { color: var(--dim-color); font-size: 0.8rem; }
        .metric-val { color: var(--guide-color); font-weight: 500; }

        .toggle-group { margin-top: 2rem; }
        .toggle-label { display: block; margin-bottom: 0.5rem; cursor: pointer; color: var(--text-color); font-size: 0.9rem;}
        .toggle-label input { margin-right: 0.5rem; }

        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: var(--bg-color); z-index: 2000;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .loader-text { font-family: var(--ui-font); animation: blink 1s infinite; margin-top: 1rem;}
        @keyframes blink { 50% { opacity: 0.5; } }

        @media (max-width: 768px) {
            .modal-window { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
            .modal-visual { border-right: none; border-bottom: 1px solid var(--line-color); }
            .dashboard-bar { grid-template-columns: 1fr; }
            .dash-item:not(:first-child) { display: none; }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-text">ANALYZING FONT DATA...</div>
    </div>

    <header>
        <div>
            <h1 class="brand">KIRIBI <span style="font-weight:300;">LAB</span></h1>
            <span class="subtitle ui-mono">TYPEFACE INSPECTION FACILITY</span>
        </div>
        <div class="ui-mono" style="text-align: right; color: var(--dim-color);">
            BUILD: 2.4.2 (HOTFIXED)<br>OPENTYPE.JS
        </div>
    </header>

    <div class="upload-section" id="uploadArea">
        <div class="drop-zone" id="dropZone">
            <span style="font-size: 3rem; display:block; margin-bottom:1rem; opacity:0.5;">⇪</span>
            <h2 class="ui-mono" style="margin-bottom:1rem;">DROP FONT FILE HERE</h2>
            <p class="ui-mono dim" style="font-size:0.8rem;">SUPPORTED FORMATS: TTF, OTF, WOFF</p>
            <label for="fileInput" class="btn-upload">SELECT FILE</label>
            <input type="file" id="fileInput" accept=".ttf,.otf,.woff,.woff2">
        </div>
    </div>

    <div id="mainInterface" style="display: none;">
        
        <div class="dashboard-bar">
            <div class="dash-item">
                <span class="dash-label ui-mono">FONT NAME</span>
                <span class="dash-value" id="fontNameDisplay">---</span>
            </div>
            <div class="dash-item">
                <span class="dash-label ui-mono">TOTAL GLYPHS</span>
                <span class="dash-value" id="glyphCountDisplay">0</span>
            </div>
            <div class="dash-item controls-area">
                <input type="text" id="searchInput" placeholder="SEARCH (U+0041)">
                <input type="range" id="sizeSlider" min="24" max="96" value="48">
            </div>
        </div>

        <div class="glyph-grid" id="glyphGridContainer"></div>

        <div style="padding: 2rem; text-align: center;">
            <button id="loadMoreBtn" class="btn-upload" style="background:transparent; border:1px solid #333; color:#fff;">LOAD NEXT 200</button>
        </div>

    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-window">
            <div class="modal-visual" id="canvasContainer">
                <canvas id="glyphCanvas"></canvas>
            </div>
            <aside class="modal-sidebar">
                <div class="modal-header">
                    <div>
                        <div class="glyph-large-title" id="modalGlyphChar">?</div>
                        <div class="ui-mono dim" id="modalGlyphName">uniXXXX</div>
                    </div>
                    <button class="close-btn" id="closeModal">×</button>
                </div>

                <div class="ui-mono">
                    <div class="metric-row">
                        <span class="metric-label">UNICODE</span>
                        <span class="metric-val" id="mUnicode">---</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">INDEX</span>
                        <span class="metric-val" id="mIndex">0</span>
                    </div>
                    <div class="metric-row" style="margin-top:1.5rem; border-bottom:none;">
                        <span class="metric-label" style="color:#fff;">METRICS (Design Units)</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Advance Width</span>
                        <span class="metric-val" id="mWidth">0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Left Side Bearing</span>
                        <span class="metric-val" id="mLSB">0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">xMin / xMax</span>
                        <span class="metric-val" id="mXBounds">0 / 0</span>
                    </div>
                     <div class="metric-row">
                        <span class="metric-label">yMin / yMax</span>
                        <span class="metric-val" id="mYBounds">0 / 0</span>
                    </div>
                </div>

                <div class="toggle-group">
                    <label class="toggle-label ui-mono">
                        <input type="checkbox" id="showMetricsCheck" checked> SHOW GUIDES
                    </label>
                    <label class="toggle-label ui-mono">
                        <input type="checkbox" id="fillGlyphCheck" checked> FILL PATH
                    </label>
                     <label class="toggle-label ui-mono">
                        <input type="checkbox" id="showPointsCheck"> SHOW POINTS
                    </label>
                </div>
                <p class="ui-mono dim" style="margin-top:2rem; font-size:0.7rem; line-height:1.5;">
                    *Cyan lines indicate Metrics.<br>
                    *Canvas is scaled to design units.
                </p>
            </aside>
        </div>
    </div>

    <script>
        let font = null;
        let glyphsList = [];
        let renderOffset = 0;
        const RENDER_BATCH = 200;
        let currentGlyphIndex = -1;

        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const gridContainer = document.getElementById('glyphGridContainer');
        const mainInterface = document.getElementById('mainInterface');
        const loader = document.getElementById('loader');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault(); dropZone.classList.add('active');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('active'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); dropZone.classList.remove('active');
            handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        function handleFile(file) {
            if (!file) return;
            loader.style.display = 'flex';
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    font = opentype.parse(e.target.result);
                    initDashboard();
                } catch (err) {
                    alert('Font parsing error: ' + err.message);
                    loader.style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function initDashboard() {
            const name = font.names.postScriptName ? font.names.postScriptName.en : (font.names.fullName.en || 'Unknown Font');
            document.getElementById('fontNameDisplay').textContent = name;
            document.getElementById('glyphCountDisplay').textContent = font.numGlyphs;
            
            glyphsList = [];
            for (let i = 0; i < font.numGlyphs; i++) {
                const glyph = font.glyphs.get(i);
                glyphsList.push({
                    index: i,
                    glyph: glyph,
                    unicode: glyph.unicode ? 'U+' + glyph.unicode.toString(16).toUpperCase().padStart(4, '0') : '---',
                    name: glyph.name || '#' + i
                });
            }

            document.getElementById('uploadArea').style.display = 'none';
            mainInterface.style.display = 'block';
            
            renderOffset = 0;
            gridContainer.innerHTML = '';
            renderNextBatch();
            loader.style.display = 'none';
        }

        function renderNextBatch() {
            const fragment = document.createDocumentFragment();
            const end = Math.min(renderOffset + RENDER_BATCH, glyphsList.length);
            const boxSize = 60; 
            const fontSize = 40; 
            const baselineY = 48; 

            for (let i = renderOffset; i < end; i++) {
                const item = glyphsList[i];
                const glyph = item.glyph;

                const cell = document.createElement('div');
                cell.className = 'glyph-cell';
                cell.onclick = () => openModal(i);

                const scale = fontSize / font.unitsPerEm;
                const glyphWidth = glyph.advanceWidth * scale;
                const xPos = (boxSize - glyphWidth) / 2;

                const path = glyph.getPath(xPos, baselineY, fontSize);
                const svgHTML = `
                    <svg width="100%" height="100%" viewBox="0 0 ${boxSize} ${boxSize}" class="glyph-svg">
                        ${path.toSVG(2)}
                    </svg>
                `;
                
                cell.innerHTML = svgHTML + `<div class="g-meta">${item.unicode}</div>`;
                fragment.appendChild(cell);
            }

            gridContainer.appendChild(fragment);
            renderOffset = end;

            if (renderOffset >= glyphsList.length) {
                document.getElementById('loadMoreBtn').style.display = 'none';
            }
        }

        document.getElementById('loadMoreBtn').addEventListener('click', renderNextBatch);

        /* --- Modal Logic (Canvas) --- */
        const modal = document.getElementById('modalOverlay');
        const canvas = document.getElementById('glyphCanvas');
        const ctx = canvas.getContext('2d');

        function openModal(index) {
            currentGlyphIndex = index;
            const item = glyphsList[index];
            const g = item.glyph;

            document.getElementById('modalGlyphChar').textContent = item.unicode !== '---' ? String.fromCharCode(item.glyph.unicode) : '';
            document.getElementById('modalGlyphName').textContent = item.name;
            document.getElementById('mUnicode').textContent = item.unicode;
            document.getElementById('mIndex').textContent = item.index;
            document.getElementById('mWidth').textContent = g.advanceWidth;
            document.getElementById('mLSB').textContent = g.leftSideBearing || 0;
            
            const bb = g.getBoundingBox();
            document.getElementById('mXBounds').textContent = `${Math.round(bb.x1)} / ${Math.round(bb.x2)}`;
            document.getElementById('mYBounds').textContent = `${Math.round(bb.y1)} / ${Math.round(bb.y2)}`;

            modal.classList.add('active');
            fitCanvas();
            drawAnalysis();
        }

        window.addEventListener('resize', () => {
            if(modal.classList.contains('active')) {
                fitCanvas();
                drawAnalysis();
            }
        });

        function fitCanvas() {
            const container = document.getElementById('canvasContainer');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        function drawAnalysis() {
            if (currentGlyphIndex < 0 || !font) return;
            
            const g = glyphsList[currentGlyphIndex].glyph;
            const w = canvas.width;
            const h = canvas.height;
            
            const showMetrics = document.getElementById('showMetricsCheck').checked;
            const fillGlyph = document.getElementById('fillGlyphCheck').checked;
            const showPoints = document.getElementById('showPointsCheck').checked;

            ctx.clearRect(0, 0, w, h);

            // 画面の高さにフォントの高さ（Ascender + Descender）が収まるようにスケール計算
            const fontHeight = font.ascender - font.descender;
            const scale = (h * 0.7) / fontHeight;

            // 座標原点を画面中央に持ってくる
            const originX = w / 2 - (g.advanceWidth * scale) / 2; 
            const originY = h / 2 + ((font.ascender + font.descender)/2 * scale); 

            ctx.save();
            ctx.translate(originX, originY);
            
            // 補助線（メトリクス）の描画
            if (showMetrics) {
                ctx.lineWidth = 1;
                ctx.strokeStyle = "rgba(0, 255, 204, 0.5)"; 
                
                drawLine(-2000, 0, 2000, 0, "#fff", 2); // Baseline

                const yAsc = -font.ascender * scale;
                drawLine(-2000, yAsc, 2000, yAsc);
                ctx.fillStyle = "rgba(0,255,204,0.7)";
                ctx.fillText("Ascender", -originX + 10, yAsc - 5);

                const yDesc = -font.descender * scale;
                drawLine(-2000, yDesc, 2000, yDesc);
                ctx.fillText("Descender", -originX + 10, yDesc - 5);

                // 横幅の境界線
                drawLine(0, -2000, 0, 2000); // LSB (0地点)
                const xAdv = g.advanceWidth * scale;
                drawLine(xAdv, -2000, xAdv, 2000); // RSB
                
                // メトリクスエリアの薄い塗り
                ctx.fillStyle = "rgba(0, 255, 204, 0.05)";
                ctx.fillRect(0, yAsc, xAdv, yDesc - yAsc);
            }

            // フォント座標系へ変換（Y反転）
            // scale倍することで、Canvas上の1単位が1スクリーンピクセルに近くなるよう調整
            ctx.scale(scale, -scale); 

            /* * 【修正箇所】
             * opentype.jsのdrawメソッドの第4引数(fontSize)には、
             * 現在の座標系における「1emあたりのサイズ」を渡す必要があります。
             * ここでは scale() ですでに座標系を縮小しているため、
             * フォント本来の座標値(1000〜2048など)で描画するには、
             * fontSizeに font.unitsPerEm を渡します。
             */
            const drawSize = font.unitsPerEm; 

            if (fillGlyph) {
                // 白い塗り
                g.draw(ctx, 0, 0, drawSize, {fill: '#fff'}); 
            } else {
                // アウトラインのみ。線の太さもスケーリングを考慮して逆算
                g.draw(ctx, 0, 0, drawSize, {fill: null, stroke: '#fff', strokeWidth: 2/scale}); 
            }

            if (showPoints) {
                // 制御点表示
                g.drawPoints(ctx, 0, 0, drawSize, {fill: '#ff0055', size: 4/scale});
            }

            ctx.restore();
        }

        function drawLine(x1, y1, x2, y2, color, width) {
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            if(color) ctx.strokeStyle = color;
            if(width) ctx.lineWidth = width;
            ctx.stroke();
            ctx.strokeStyle = "rgba(0, 255, 204, 0.5)"; 
            ctx.lineWidth = 1;
        }

        document.getElementById('closeModal').onclick = () => {
            modal.classList.remove('active');
        };
        modal.onclick = (e) => {
            if (e.target === modal) modal.classList.remove('active');
        };
        
        document.querySelectorAll('.toggle-group input').forEach(input => {
            input.addEventListener('change', drawAnalysis);
        });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const val = e.target.value.toUpperCase();
            const cells = gridContainer.getElementsByClassName('glyph-cell');
            Array.from(cells).forEach(cell => {
                const meta = cell.querySelector('.g-meta').textContent;
                if (meta.includes(val)) {
                    cell.style.display = 'flex';
                } else {
                    cell.style.display = 'none';
                }
            });
        });

        document.getElementById('sizeSlider').addEventListener('input', (e) => {
           const size = e.target.value;
           gridContainer.style.gridTemplateColumns = `repeat(auto-fill, minmax(${size*1.5}px, 1fr))`;
        });
    </script>
</body>
</html>
