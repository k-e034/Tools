<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æãã‚¤ãƒ©ã‚¹ãƒˆãƒ‡ã‚¸ã‚¿ãƒ«å¤‰æ›ãƒ„ãƒ¼ãƒ« - ã‚ãŸãã—ã®é“å…·ç®±</title>
    <link rel="icon" href="images/icons/favicon.ico" sizes="32x32">
    <link rel="icon" href="images/icons/favicon.svg" type="image/svg">
    <link rel="stylesheet" href="css/main.css">
    <style>
        .tool-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .tool-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .tool-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        
        .tool-description {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .control-panel {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }
        
        .control-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .control-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
            min-width: 60px;
        }
        
        .control-btn:hover {
            background: #e9ecef;
        }
        
        .control-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .control-btn:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }
        
        .upload-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
        }
        
        .upload-btn:hover {
            background: #2980b9;
        }
        
        .process-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background 0.3s ease;
            margin: 1rem auto;
            display: block;
        }
        
        .process-btn:hover:not(:disabled) {
            background: #229954;
        }
        
        .process-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .preview-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .preview-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        
        .preview-area {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .preview-placeholder {
            color: #6c757d;
            text-align: center;
        }
        
        .download-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
            width: 100%;
        }
        
        .download-btn:hover {
            background: #2980b9;
        }
        
        .guide-section {
            margin-top: 2rem;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .guide-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        
        .guide-list {
            list-style: decimal;
            padding-left: 1.5rem;
        }
        
        .guide-list li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }
        
        .guide-list ul {
            list-style: disc;
            margin-top: 0.5rem;
            padding-left: 1.5rem;
        }
        
        .guide-list strong {
            color: #2c3e50;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .tool-container {
                padding: 1rem;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .control-options {
                gap: 0.25rem;
            }
            
            .control-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .preview-grid {
                grid-template-columns: 1fr;
            }
            
            .preview-area {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header>
        <div class="header-container">
            <div class="logo"><a href="index.html">ã‚ãŸãã—ã®é“å…·ç®±</a></div>
            <nav>
                <ul>
                    <li><a href="index.html">ãƒ›ãƒ¼ãƒ </a></li>
                    <li><a href="https://k-e034.github.io/satueiki/">æ’®å½±è¨˜ã¸</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">
        <div class="tool-container">
            <div class="tool-header">
                <h1 class="tool-title">æ‰‹æãã‚¤ãƒ©ã‚¹ãƒˆãƒ‡ã‚¸ã‚¿ãƒ«å¤‰æ›ãƒ„ãƒ¼ãƒ«</h1>
                <p class="tool-description">æ‰‹æãã®ã‚¹ã‚±ãƒƒãƒã‚’ç¾ã—ã„ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¤ãƒ©ã‚¹ãƒˆã«å¤‰æ›ã—ã¾ã™</p>
            </div>
            
            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
            <div class="control-panel">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        ğŸ“ ã‚¤ãƒ©ã‚¹ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </button>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                </div>
                
                <div class="control-grid">
                    <div class="control-group">
                        <label class="control-label">å‡ºåŠ›ã‚¿ã‚¤ãƒ—</label>
                        <div class="control-options">
                            <button class="control-btn active" data-setting="outputType" data-value="vector">ãƒ™ã‚¯ã‚¿ãƒ¼</button>
                            <button class="control-btn" data-setting="outputType" data-value="raster">ãƒ©ã‚¹ã‚¿ãƒ¼</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">å‡¦ç†ãƒ¬ãƒ™ãƒ«</label>
                        <div class="control-options">
                            <button class="control-btn" data-setting="processingLevel" data-value="1">ä½</button>
                            <button class="control-btn active" data-setting="processingLevel" data-value="2">ä¸­</button>
                            <button class="control-btn" data-setting="processingLevel" data-value="3">é«˜</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">ã‚«ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ‰</label>
                        <div class="control-options">
                            <button class="control-btn active" data-setting="colorMode" data-value="original">ã‚ªãƒªã‚¸ãƒŠãƒ«</button>
                            <button class="control-btn" data-setting="colorMode" data-value="grayscale">ç™½é»’</button>
                            <button class="control-btn" data-setting="colorMode" data-value="highContrast">é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">é‰›ç­†ãƒ†ã‚¯ã‚¹ãƒãƒ£</label>
                        <div class="control-options">
                            <button class="control-btn active" data-setting="textureMode" data-value="smooth">ã‚¹ãƒ ãƒ¼ã‚¹</button>
                            <button class="control-btn" data-setting="textureMode" data-value="sketch">è»½ã„é‰›ç­†æ„Ÿ</button>
                            <button class="control-btn" data-setting="textureMode" data-value="pencil">å¼·ã„é‰›ç­†æ„Ÿ</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</label>
                        <div class="control-options">
                            <button class="control-btn active" data-setting="outputFormat" data-value="png">PNG</button>
                            <button class="control-btn" data-setting="outputFormat" data-value="webp">WebP</button>
                            <button class="control-btn" data-setting="outputFormat" data-value="svg">SVG</button>
                        </div>
                    </div>
                </div>
                
                <button class="process-btn" id="processBtn" disabled>
                    âš™ï¸ å¤‰æ›ã™ã‚‹
                </button>
            </div>
            
            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div class="preview-grid">
                <div class="preview-card">
                    <h2 class="preview-title">å…ƒã®ç”»åƒ</h2>
                    <div class="preview-area" id="originalPreview">
                        <div class="preview-placeholder">ç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
                    </div>
                </div>
                
                <div class="preview-card">
                    <h2 class="preview-title">å‡¦ç†æ¸ˆã¿ç”»åƒ</h2>
                    <div class="preview-area" id="processedPreview">
                        <div class="preview-placeholder">ç”»åƒãŒå‡¦ç†ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
                    </div>
                    <button class="download-btn hidden" id="downloadBtn">
                        ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>
            </div>
            
            <!-- ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ -->
            <div class="guide-section">
                <h2 class="guide-title">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h2>
                <ol class="guide-list">
                    <li>ã€Œã‚¤ãƒ©ã‚¹ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ‰‹æãã‚¤ãƒ©ã‚¹ãƒˆã‚’é¸æŠ</li>
                    <li>å‡ºåŠ›ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ:
                        <ul>
                            <li><strong>ãƒ™ã‚¯ã‚¿ãƒ¼</strong>: ç·šç”»ã‚’å¼·èª¿ã—ã€SVGã®ã‚ˆã†ãªã‚¯ãƒªã‚¢ãªç·šã‚’ç”Ÿæˆ</li>
                            <li><strong>ãƒ©ã‚¹ã‚¿ãƒ¼</strong>: ã‚ˆã‚Šè‡ªç„¶ãªè³ªæ„Ÿã‚’ä¿æŒã—ã¤ã¤ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–</li>
                        </ul>
                    </li>
                    <li>å‡¦ç†ãƒ¬ãƒ™ãƒ«ï¼ˆä½ãƒ»ä¸­ãƒ»é«˜ï¼‰ã§è©³ç´°ã•ã¨ã‚¹ãƒ ãƒ¼ã‚¹ã•ã‚’èª¿æ•´</li>
                    <li>ã‚«ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚«ãƒ©ãƒ¼ã‚’ä¿æŒã™ã‚‹ã‹ç™½é»’ã«ã™ã‚‹ã‹é¸æŠ</li>
                    <li>é‰›ç­†ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’é¸æŠ:
                        <ul>
                            <li><strong>ã‚¹ãƒ ãƒ¼ã‚¹</strong>: ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ‡ã‚¸ã‚¿ãƒ«ã‚¤ãƒ©ã‚¹ãƒˆé¢¨</li>
                            <li><strong>è»½ã„é‰›ç­†æ„Ÿ</strong>: ã‚ãšã‹ãªç²’çŠ¶æ„Ÿã¨ä¸å‡ä¸€ã•ã‚’ä¿æŒ</li>
                            <li><strong>å¼·ã„é‰›ç­†æ„Ÿ</strong>: ç´™ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨é‰›ç­†ã®ç²’çŠ¶æ„Ÿã‚’å†ç¾</li>
                        </ul>
                    </li>
                    <li>å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é¸æŠ:
                        <ul>
                            <li><strong>PNG</strong>: é«˜å“è³ªç”»åƒã€é€æ˜åº¦å¯¾å¿œ</li>
                            <li><strong>WebP</strong>: è»½é‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã€ã‚¦ã‚§ãƒ–ç”¨ã«æœ€é©åŒ–</li>
                            <li><strong>SVG</strong>: ç·¨é›†å¯èƒ½ãªãƒ™ã‚¯ã‚¿ãƒ¼å½¢å¼ï¼ˆãƒ™ã‚¯ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ—ã®ã¿ï¼‰</li>
                        </ul>
                    </li>
                    <li>ã€Œå¤‰æ›ã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‡¦ç†é–‹å§‹</li>
                    <li>å‡¦ç†å¾Œã€çµæœã‚’ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã§ä¿å­˜</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h3>ã‚ãŸãã—ã®é“å…·ç®±</h3>
                <p>æ—¥å¸¸ã§ä½¿ãˆã‚‹ä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«ã‚’é–‹ç™ºãƒ»å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚</p>
            </div>
            <div class="footer-section">
                <h3>ãƒªãƒ³ã‚¯</h3>
                <ul>
                    <li><a href="index.html">ãƒ›ãƒ¼ãƒ </a></li>
                    <li><a href="https://k-e034.github.io/satueiki/">æ’®å½±è¨˜</a></li>
                </ul>
            </div>
        </div>
        <div class="copyright">&copy; 2025 k.e. All Rights Reserved.</div>
    </footer>

    <!-- éš ã—ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        // è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        const settings = {
            outputType: 'vector',
            processingLevel: 2,
            colorMode: 'original',
            textureMode: 'smooth',
            outputFormat: 'png'
        };

        let originalImage = null;
        let processedImage = null;
        let isProcessing = false;

        // DOMè¦ç´ 
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const originalPreview = document.getElementById('originalPreview');
        const processedPreview = document.getElementById('processedPreview');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
            fileInput.addEventListener('change', handleFileUpload);
            
            // å‡¦ç†ãƒœã‚¿ãƒ³
            processBtn.addEventListener('click', processImage);
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
            downloadBtn.addEventListener('click', downloadImage);
            
            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³
            document.querySelectorAll('.control-btn[data-setting]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const setting = this.getAttribute('data-setting');
                    const value = this.getAttribute('data-value');
                    
                    // åŒã˜è¨­å®šã‚°ãƒ«ãƒ¼ãƒ—ã®ä»–ã®ãƒœã‚¿ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                    document.querySelectorAll(`[data-setting="${setting}"]`).forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                    this.classList.add('active');
                    
                    // è¨­å®šã‚’æ›´æ–°
                    settings[setting] = value;
                    
                    // SVGãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ‡æ›¿
                    updateSVGButtonState();
                });
            });
            
            // åˆæœŸçŠ¶æ…‹ã§SVGãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’è¨­å®š
            updateSVGButtonState();
        });

        function updateSVGButtonState() {
            const svgBtn = document.querySelector('[data-setting="outputFormat"][data-value="svg"]');
            if (settings.outputType !== 'vector') {
                svgBtn.disabled = true;
                svgBtn.classList.add('disabled');
                if (settings.outputFormat === 'svg') {
                    // SVGãŒé¸æŠã•ã‚Œã¦ã„ã¦ãƒ™ã‚¯ã‚¿ãƒ¼ã§ãªã„å ´åˆã€PNGã«å¤‰æ›´
                    settings.outputFormat = 'png';
                    svgBtn.classList.remove('active');
                    document.querySelector('[data-setting="outputFormat"][data-value="png"]').classList.add('active');
                }
            } else {
                svgBtn.disabled = false;
                svgBtn.classList.remove('disabled');
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    originalImage = img;
                    
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                    originalPreview.innerHTML = `<img src="${event.target.result}" alt="Original sketch" class="preview-image">`;
                    
                    // å‡¦ç†ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                    processBtn.disabled = false;
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ç”»åƒå‡¦ç†ãƒ¡ã‚¤ãƒ³é–¢æ•°
        function processImage() {
            if (!originalImage || isProcessing) return;
            
            isProcessing = true;
            processBtn.disabled = true;
            processBtn.innerHTML = 'âš™ï¸ å‡¦ç†ä¸­...';
            
            // Canvasè¨­å®š
            canvas.width = originalImage.width;
            canvas.height = originalImage.height;
            
            // å…ƒç”»åƒã‚’æç”»
            ctx.drawImage(originalImage, 0, 0);
            
            // éåŒæœŸã§å‡¦ç†å®Ÿè¡Œ
            setTimeout(() => {
                try {
                    // ç”»åƒãƒ‡ãƒ¼ã‚¿å–å¾—
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // å‡ºåŠ›ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦å‡¦ç†
                    if (settings.outputType === 'vector') {
                        processVector(data, canvas.width, canvas.height);
                    } else {
                        processRaster(data, imageData);
                    }
                    
                    // ã‚«ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ‰é©ç”¨
                    applyColorMode();
                    
                    // ãƒ†ã‚¯ã‚¹ãƒãƒ£é©ç”¨
                    if (settings.textureMode !== 'smooth') {
                        applyTexture();
                    }
                    
                    // çµæœç”Ÿæˆ
                    generateOutput();
                    
                } catch (error) {
                    console.error('å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ç”»åƒå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                } finally {
                    isProcessing = false;
                    processBtn.disabled = false;
                    processBtn.innerHTML = 'âš™ï¸ å¤‰æ›ã™ã‚‹';
                }
            }, 100);
        }

        // ãƒ™ã‚¯ã‚¿ãƒ¼å‡¦ç†
        function processVector(data, width, height) {
            const edges = detectEdges(data, width, height);
            applyEdges(edges, width, height);
            
            if (settings.processingLevel > 1) {
                smoothLines();
            }
        }

        // ãƒ©ã‚¹ã‚¿ãƒ¼å‡¦ç†
        function processRaster(data, imageData) {
            enhanceContrast(data);
            ctx.putImageData(imageData, 0, 0);
            
            if (settings.processingLevel > 1) {
                applyBlur();
            }
        }

        // ã‚¨ãƒƒã‚¸æ¤œå‡º
        function detectEdges(data, width, height) {
            const edges = new Uint8ClampedArray(width * height);
            const threshold = 30 - settings.processingLevel * 5;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    const idx1 = ((y-1) * width + x) * 4;
                    const idx2 = ((y+1) * width + x) * 4;
                    const idx3 = (y * width + (x-1)) * 4;
                    const idx4 = (y * width + (x+1)) * 4;
                    
                    const gx = -1 * data[idx1] + 1 * data[idx2] + -2 * data[idx3] + 2 * data[idx4];
                    const gy = -1 * data[idx3] + 1 * data[idx4] + -2 * data[idx1] + 2 * data[idx2];
                    const g = Math.sqrt(gx*gx + gy*gy);
                    
                    edges[y * width + x] = g > threshold ? 255 : 0;
                }
            }
            
            return edges;
        }

        // ã‚¨ãƒƒã‚¸é©ç”¨
        function applyEdges(edges, width, height) {
            const imgData = ctx.getImageData(0, 0, width, height);
            const data = imgData.data;
            
            for (let i = 0; i < width * height; i++) {
                const edge = edges[i];
                const idx = i * 4;
                
                if (edge === 255) {
                    data[idx] = 0;
                    data[idx+1] = 0;
                    data[idx+2] = 0;
                    data[idx+3] = 255;
                } else {
                    data[idx] = 255;
                    data[idx+1] = 255;
                    data[idx+2] = 255;
                    data[idx+3] = 0;
                }
            }
            
            ctx.putImageData(imgData, 0, 0);
        }

        // ç·šã®ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°
        function smoothLines() {
            ctx.filter = `blur(${settings.processingLevel * 0.5}px)`;
            const temp = ctx.getImageData(0, 0, canvas.width, canvas.height);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.putImageData(temp, 0, 0);
            ctx.filter = 'none';
        }

        // ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·èª¿
        function enhanceContrast(data) {
            const factor = 1.2 + (settings.processingLevel * 0.2);
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, (data[i] - 128) * factor + 128));
                data[i+1] = Math.min(255, Math.max(0, (data[i+1] - 128) * factor + 128));
                data[i+2] = Math.min(255, Math.max(0, (data[i+2] - 128) * factor + 128));
            }
        }

        // ã¼ã‹ã—é©ç”¨
        function applyBlur() {
            ctx.filter = `blur(${settings.processingLevel * 0.5}px)`;
            const temp = ctx.getImageData(0, 0, canvas.width, canvas.height);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.putImageData(temp, 0, 0);
            ctx.filter = 'none';
        }

        // ã‚«ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ‰é©ç”¨
        function applyColorMode() {
            if (settings.colorMode === 'original') return;
            
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                if (settings.colorMode === 'grayscale') {
                    const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                    data[i] = avg;
                    data[i+1] = avg;
                    data[i+2] = avg;
                } else if (settings.colorMode === 'highContrast') {
                    const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                    const val = avg > 128 ? 255 : 0;
                    data[i] = val;
                    data[i+1] = val;
                    data[i+2] = val;
                }
            }
            
            ctx.putImageData(imgData, 0, 0);
        }

        // ãƒ†ã‚¯ã‚¹ãƒãƒ£é©ç”¨
        function applyTexture() {
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;
            
            if (settings.textureMode === 'sketch') {
                // ã‚¹ã‚±ãƒƒãƒé¢¨ãƒ†ã‚¯ã‚¹ãƒãƒ£
                for (let y = 0; y < canvas.height; y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        const idx = (y * canvas.width + x) * 4;
                        
                        if (data[idx] < 100 && data[idx+1] < 100 && data[idx+2] < 100 && data[idx+3] > 0) {
                            const noise = Math.random() * 30;
                            data[idx] = Math.min(255, data[idx] + noise);
                            data[idx+1] = Math.min(255, data[idx+1] + noise);
                            data[idx+2] = Math.min(255, data[idx+2] + noise);
                            
                            if (Math.random() > 0.85) {
                                data[idx+3] = Math.max(0, data[idx+3] - Math.random() * 100);
                            }
                        }
                    }
                }
            } else if (settings.textureMode === 'pencil') {
                // é‰›ç­†é¢¨ãƒ†ã‚¯ã‚¹ãƒãƒ£
                for (let i = 0; i < data.length; i += 4) {
                    if (data[i] < 100 && data[i+1] < 100 && data[i+2] < 100) {
                        const variance = Math.random() * 20 - 10;
                        data[i] = Math.max(0, Math.min(255, data[i] + variance));
                        data[i+1] = Math.max(0, Math.min(255, data[i+1] + variance));
                        data[i+2] = Math.max(0, Math.min(255, data[i+2] + variance));
                    }
                }
            }
            
            ctx.putImageData(imgData, 0, 0);
        }

        // å‡ºåŠ›ç”Ÿæˆ
        function generateOutput() {
            const format = settings.outputFormat === 'webp' ? 'image/webp' : 'image/png';
            const quality = settings.outputFormat === 'webp' ? 0.8 : 1.0;
            
            if (settings.outputFormat === 'svg' && settings.outputType === 'vector') {
                generateSVG();
            } else {
                processedImage = canvas.toDataURL(format, quality);
                displayResult();
            }
        }

        // SVGç”Ÿæˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function generateSVG() {
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;
            
            let svgContent = `<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}" viewBox="0 0 ${canvas.width} ${canvas.height}">`;
            
            // é»’ã„ãƒ”ã‚¯ã‚»ãƒ«ã‚’å°ã•ãªå††ã¨ã—ã¦æç”»ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            for (let y = 0; y < canvas.height; y += 2) {
                for (let x = 0; x < canvas.width; x += 2) {
                    const idx = (y * canvas.width + x) * 4;
                    if (data[idx] < 50 && data[idx+1] < 50 && data[idx+2] < 50 && data[idx+3] > 200) {
                        svgContent += `<circle cx="${x}" cy="${y}" r="0.5" fill="black"/>`;
                    }
                }
            }
            
            svgContent += `</svg>`;
            
            const svgBlob = new Blob([svgContent], {type: 'image/svg+xml'});
            const reader = new FileReader();
            reader.onloadend = () => {
                processedImage = reader.result;
                displayResult();
            };
            reader.readAsDataURL(svgBlob);
        }

        // çµæœè¡¨ç¤º
        function displayResult() {
            processedPreview.innerHTML = `<img src="${processedImage}" alt="Processed sketch" class="preview-image">`;
            downloadBtn.classList.remove('hidden');
        }

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function downloadImage() {
            if (!processedImage) return;
            
            try {
                const link = document.createElement('a');
                link.href = processedImage;
                
                const extension = settings.outputFormat === 'svg' ? 'svg' : 
                                 settings.outputFormat === 'webp' ? 'webp' : 'png';
                link.download = `digitized_${settings.outputType}_sketch.${extension}`;
                
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }
    </script>
</body>
</html>