<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊâãÊèè„Åç„Ç§„É©„Çπ„Éà„Éá„Ç∏„Çø„É´Â§âÊèõ„ÉÑ„Éº„É´ - „Çè„Åü„Åè„Åó„ÅÆÈÅìÂÖ∑ÁÆ±</title>
    <link rel="icon" href="images/icons/favicon.ico" sizes="32x32">
    <link rel="icon" href="images/icons/favicon.svg" type="image/svg">
    <link rel="stylesheet" href="css/main.css">
    <style>
        .tool-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .tool-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .tool-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        
        .tool-description {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .control-panel {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }
        
        .control-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .control-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
            min-width: 60px;
        }
        
        .control-btn:hover {
            background: #e9ecef;
        }
        
        .control-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .control-btn:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }
        
        .upload-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
        }
        
        .upload-btn:hover {
            background: #2980b9;
        }
        
        .process-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background 0.3s ease;
            margin: 1rem auto;
            display: block;
        }
        
        .process-btn:hover:not(:disabled) {
            background: #229954;
        }
        
        .process-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .preview-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .preview-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        
        .preview-area {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .preview-placeholder {
            color: #6c757d;
            text-align: center;
        }
        
        .download-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
            width: 100%;
        }
        
        .download-btn:hover {
            background: #2980b9;
        }
        
        .guide-section {
            margin-top: 2rem;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .guide-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        
        .guide-list {
            list-style: decimal;
            padding-left: 1.5rem;
        }
        
        .guide-list li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }
        
        .guide-list ul {
            list-style: disc;
            margin-top: 0.5rem;
            padding-left: 1.5rem;
        }
        
        .guide-list strong {
            color: #2c3e50;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .tool-container {
                padding: 1rem;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .control-options {
                gap: 0.25rem;
            }
            
            .control-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .preview-grid {
                grid-template-columns: 1fr;
            }
            
            .preview-area {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <header>
        <div class="header-container">
            <div class="logo"><a href="index.html">„Çè„Åü„Åè„Åó„ÅÆÈÅìÂÖ∑ÁÆ±</a></div>
            <nav>
                <ul>
                    <li><a href="index.html">„Éõ„Éº„É†</a></li>
                    <li><a href="https://k-e034.github.io/satueiki/">ÊíÆÂΩ±Ë®ò„Å∏</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <div class="main-content">
        <div class="tool-container">
            <div class="tool-header">
                <h1 class="tool-title">ÊâãÊèè„Åç„Ç§„É©„Çπ„Éà„Éá„Ç∏„Çø„É´Â§âÊèõ„ÉÑ„Éº„É´</h1>
                <p class="tool-description">ÊâãÊèè„Åç„ÅÆ„Çπ„Ç±„ÉÉ„ÉÅ„ÇíÁæé„Åó„ÅÑ„Éá„Ç∏„Çø„É´„Ç§„É©„Çπ„Éà„Å´Â§âÊèõ„Åó„Åæ„Åô</p>
            </div>
            
            <!-- „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ -->
            <div class="control-panel">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        üìÅ „Ç§„É©„Çπ„Éà„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                    </button>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                </div>
                
                <div class="control-grid">
                    <div class="control-group">
                        <label class="control-label">Âá∫Âäõ„Çø„Ç§„Éó</label>
                        <div class="control-options">
                            <button class="control-btn active" data-setting="outputType" data-value="vector">„Éô„ÇØ„Çø„Éº</button>
                            <button class="control-btn" data-setting="outputType" data-value="raster">„É©„Çπ„Çø„Éº</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Âá¶ÁêÜ„É¨„Éô„É´</label>
                        <div class="control-options">
                            <button class="control-btn" data-setting="processingLevel" data-value="1">‰Ωé</button>
                            <button class="control-btn active" data-setting="processingLevel" data-value="2">‰∏≠</button>
                            <button class="control-btn" data-setting="processingLevel" data-value="3">È´ò</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">„Ç´„É©„Éº„É¢„Éº„Éâ</label>
                        <div class="control-options">
                            <button class="control-btn active" data-setting="colorMode" data-value="original">„Ç™„É™„Ç∏„Éä„É´</button>
                            <button class="control-btn" data-setting="colorMode" data-value="grayscale">ÁôΩÈªí</button>
                            <button class="control-btn" data-setting="colorMode" data-value="highContrast">È´ò„Ç≥„É≥„Éà„É©„Çπ„Éà</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">ÈâõÁ≠Ü„ÉÜ„ÇØ„Çπ„ÉÅ„É£</label>
                        <div class="control-options">
                            <button class="control-btn active" data-setting="textureMode" data-value="smooth">„Çπ„É†„Éº„Çπ</button>
                            <button class="control-btn" data-setting="textureMode" data-value="sketch">ËªΩ„ÅÑÈâõÁ≠ÜÊÑü</button>
                            <button class="control-btn" data-setting="textureMode" data-value="pencil">Âº∑„ÅÑÈâõÁ≠ÜÊÑü</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Âá∫Âäõ„Éï„Ç©„Éº„Éû„ÉÉ„Éà</label>
                        <div class="control-options">
                            <button class="control-btn active" data-setting="outputFormat" data-value="png">PNG</button>
                            <button class="control-btn" data-setting="outputFormat" data-value="webp">WebP</button>
                            <button class="control-btn" data-setting="outputFormat" data-value="svg">SVG</button>
                        </div>
                    </div>
                </div>
                
                <button class="process-btn" id="processBtn" disabled>
                    ‚öôÔ∏è Â§âÊèõ„Åô„Çã
                </button>
            </div>
            
            <!-- „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢ -->
            <div class="preview-grid">
                <div class="preview-card">
                    <h2 class="preview-title">ÂÖÉ„ÅÆÁîªÂÉè</h2>
                    <div class="preview-area" id="originalPreview">
                        <div class="preview-placeholder">ÁîªÂÉè„Åå„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>
                    </div>
                </div>
                
                <div class="preview-card">
                    <h2 class="preview-title">Âá¶ÁêÜÊ∏à„ÅøÁîªÂÉè</h2>
                    <div class="preview-area" id="processedPreview">
                        <div class="preview-placeholder">ÁîªÂÉè„ÅåÂá¶ÁêÜ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>
                    </div>
                    <button class="download-btn hidden" id="downloadBtn">
                        üíæ „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                    </button>
                </div>
            </div>
            
            <!-- ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ -->
            <div class="guide-section">
                <h2 class="guide-title">‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</h2>
                <ol class="guide-list">
                    <li>„Äå„Ç§„É©„Çπ„Éà„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÊâãÊèè„Åç„Ç§„É©„Çπ„Éà„ÇíÈÅ∏Êäû</li>
                    <li>Âá∫Âäõ„Çø„Ç§„Éó„ÇíÈÅ∏Êäû:
                        <ul>
                            <li><strong>„Éô„ÇØ„Çø„Éº</strong>: Á∑öÁîª„ÇíÂº∑Ë™ø„Åó„ÄÅSVG„ÅÆ„Çà„ÅÜ„Å™„ÇØ„É™„Ç¢„Å™Á∑ö„ÇíÁîüÊàê</li>
                            <li><strong>„É©„Çπ„Çø„Éº</strong>: „Çà„ÇäËá™ÁÑ∂„Å™Ë≥™ÊÑü„Çí‰øùÊåÅ„Åó„Å§„Å§„Éá„Ç∏„Çø„É´Âåñ</li>
                        </ul>
                    </li>
                    <li>Âá¶ÁêÜ„É¨„Éô„É´Ôºà‰Ωé„Éª‰∏≠„ÉªÈ´òÔºâ„ÅßË©≥Á¥∞„Åï„Å®„Çπ„É†„Éº„Çπ„Åï„ÇíË™øÊï¥</li>
                    <li>„Ç´„É©„Éº„É¢„Éº„Éâ„Åß„Ç™„É™„Ç∏„Éä„É´„Ç´„É©„Éº„Çí‰øùÊåÅ„Åô„Çã„ÅãÁôΩÈªí„Å´„Åô„Çã„ÅãÈÅ∏Êäû</li>
                    <li>ÈâõÁ≠Ü„ÉÜ„ÇØ„Çπ„ÉÅ„É£„ÇíÈÅ∏Êäû:
                        <ul>
                            <li><strong>„Çπ„É†„Éº„Çπ</strong>: „ÇØ„É™„Éº„É≥„Å™„Éá„Ç∏„Çø„É´„Ç§„É©„Çπ„ÉàÈ¢®</li>
                            <li><strong>ËªΩ„ÅÑÈâõÁ≠ÜÊÑü</strong>: „Çè„Åö„Åã„Å™Á≤íÁä∂ÊÑü„Å®‰∏çÂùá‰∏Ä„Åï„Çí‰øùÊåÅ</li>
                            <li><strong>Âº∑„ÅÑÈâõÁ≠ÜÊÑü</strong>: Á¥ô„ÅÆ„ÉÜ„ÇØ„Çπ„ÉÅ„É£„Å®ÈâõÁ≠Ü„ÅÆÁ≤íÁä∂ÊÑü„ÇíÂÜçÁèæ</li>
                        </ul>
                    </li>
                    <li>Âá∫Âäõ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÇíÈÅ∏Êäû:
                        <ul>
                            <li><strong>PNG</strong>: È´òÂìÅË≥™ÁîªÂÉè„ÄÅÈÄèÊòéÂ∫¶ÂØæÂøú</li>
                            <li><strong>WebP</strong>: ËªΩÈáè„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÄÅ„Ç¶„Çß„ÉñÁî®„Å´ÊúÄÈÅ©Âåñ</li>
                            <li><strong>SVG</strong>: Á∑®ÈõÜÂèØËÉΩ„Å™„Éô„ÇØ„Çø„ÉºÂΩ¢ÂºèÔºà„Éô„ÇØ„Çø„Éº„Çø„Ç§„Éó„ÅÆ„ÅøÔºâ</li>
                        </ul>
                    </li>
                    <li>„ÄåÂ§âÊèõ„Åô„Çã„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Âá¶ÁêÜÈñãÂßã</li>
                    <li>Âá¶ÁêÜÂæå„ÄÅÁµêÊûú„Çí„Äå„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Äç„Éú„Çø„É≥„Åß‰øùÂ≠ò</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- „Éï„ÉÉ„Çø„Éº -->
    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h3>„Çè„Åü„Åè„Åó„ÅÆÈÅìÂÖ∑ÁÆ±</h3>
                <p>Êó•Â∏∏„Åß‰Ωø„Åà„Çã‰æøÂà©„Å™„ÉÑ„Éº„É´„ÇíÈñãÁô∫„ÉªÂÖ¨Èñã„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
            </div>
            <div class="footer-section">
                <h3>„É™„É≥„ÇØ</h3>
                <ul>
                    <li><a href="index.html">„Éõ„Éº„É†</a></li>
                    <li><a href="https://k-e034.github.io/satueiki/">ÊíÆÂΩ±Ë®ò</a></li>
                </ul>
            </div>
        </div>
        <div class="copyright">&copy; 2025 k.e. All Rights Reserved.</div>
    </footer>

    <!-- Èö†„Åó„Ç≠„É£„É≥„Éê„Çπ -->
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        // Ë®≠ÂÆö„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
        const settings = {
            outputType: 'vector',
            processingLevel: 2,
            colorMode: 'original',
            textureMode: 'smooth',
            outputFormat: 'png'
        };

        let originalImage = null;
        let processedImage = null;
        let isProcessing = false;

        // DOMË¶ÅÁ¥†
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const originalPreview = document.getElementById('originalPreview');
        const processedPreview = document.getElementById('processedPreview');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        document.addEventListener('DOMContentLoaded', function() {
            // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû
            fileInput.addEventListener('change', handleFileUpload);
            
            // Âá¶ÁêÜ„Éú„Çø„É≥
            processBtn.addEventListener('click', processImage);
            
            // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥
            downloadBtn.addEventListener('click', downloadImage);
            
            // „Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥
            document.querySelectorAll('.control-btn[data-setting]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const setting = this.getAttribute('data-setting');
                    const value = this.getAttribute('data-value');
                    
                    // Âêå„ÅòË®≠ÂÆö„Ç∞„É´„Éº„Éó„ÅÆ‰ªñ„ÅÆ„Éú„Çø„É≥„ÇíÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
                    document.querySelectorAll(`[data-setting="${setting}"]`).forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Éú„Çø„É≥„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
                    this.classList.add('active');
                    
                    // Ë®≠ÂÆö„ÇíÊõ¥Êñ∞
                    settings[setting] = value;
                    
                    // SVG„Éú„Çø„É≥„ÅÆÊúâÂäπ/ÁÑ°ÂäπÂàáÊõø
                    updateSVGButtonState();
                });
            });
            
            // ÂàùÊúüÁä∂ÊÖã„ÅßSVG„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíË®≠ÂÆö
            updateSVGButtonState();
        });

        function updateSVGButtonState() {
            const svgBtn = document.querySelector('[data-setting="outputFormat"][data-value="svg"]');
            if (settings.outputType !== 'vector') {
                svgBtn.disabled = true;
                svgBtn.classList.add('disabled');
                if (settings.outputFormat === 'svg') {
                    // SVG„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å¶„Éô„ÇØ„Çø„Éº„Åß„Å™„ÅÑÂ†¥Âêà„ÄÅPNG„Å´Â§âÊõ¥
                    settings.outputFormat = 'png';
                    svgBtn.classList.remove('active');
                    document.querySelector('[data-setting="outputFormat"][data-value="png"]').classList.add('active');
                }
            } else {
                svgBtn.disabled = false;
                svgBtn.classList.remove('disabled');
            }
        }

        // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    originalImage = img;
                    
                    // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
                    originalPreview.innerHTML = `<img src="${event.target.result}" alt="Original sketch" class="preview-image">`;
                    
                    // Âá¶ÁêÜ„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                    processBtn.disabled = false;
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ÁîªÂÉèÂá¶ÁêÜ„É°„Ç§„É≥Èñ¢Êï∞
        function processImage() {
            if (!originalImage || isProcessing) return;
            
            isProcessing = true;
            processBtn.disabled = true;
            processBtn.innerHTML = '‚öôÔ∏è Âá¶ÁêÜ‰∏≠...';
            
            // CanvasË®≠ÂÆö
            canvas.width = originalImage.width;
            canvas.height = originalImage.height;
            
            // ÂÖÉÁîªÂÉè„ÇíÊèèÁîª
            ctx.drawImage(originalImage, 0, 0);
            
            // ÈùûÂêåÊúü„ÅßÂá¶ÁêÜÂÆüË°å
            setTimeout(() => {
                try {
                    // ÁîªÂÉè„Éá„Éº„ÇøÂèñÂæó
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Âá∫Âäõ„Çø„Ç§„Éó„Å´Âü∫„Å•„ÅÑ„Å¶Âá¶ÁêÜ
                    if (settings.outputType === 'vector') {
                        processVector(data, canvas.width, canvas.height);
                    } else {
                        processRaster(data, imageData);
                    }
                    
                    // „Ç´„É©„Éº„É¢„Éº„ÉâÈÅ©Áî®
                    applyColorMode();
                    
                    // „ÉÜ„ÇØ„Çπ„ÉÅ„É£ÈÅ©Áî®
                    if (settings.textureMode !== 'smooth') {
                        applyTexture();
                    }
                    
                    // ÁµêÊûúÁîüÊàê
                    generateOutput();
                    
                } catch (error) {
                    console.error('Âá¶ÁêÜ„Ç®„É©„Éº:', error);
                    alert('ÁîªÂÉèÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
                } finally {
                    isProcessing = false;
                    processBtn.disabled = false;
                    processBtn.innerHTML = '‚öôÔ∏è Â§âÊèõ„Åô„Çã';
                }
            }, 100);
        }

        // „Éô„ÇØ„Çø„ÉºÂá¶ÁêÜ
        function processVector(data, width, height) {
            const edges = detectEdges(data, width, height);
            applyEdges(edges, width, height);
            
            if (settings.processingLevel > 1) {
                smoothLines();
            }
        }

        // „É©„Çπ„Çø„ÉºÂá¶ÁêÜ
        function processRaster(data, imageData) {
            enhanceContrast(data);
            ctx.putImageData(imageData, 0, 0);
            
            if (settings.processingLevel > 1) {
                applyBlur();
            }
        }

        // „Ç®„ÉÉ„Ç∏Ê§úÂá∫
        function detectEdges(data, width, height) {
            const edges = new Uint8ClampedArray(width * height);
            const threshold = 30 - settings.processingLevel * 5;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    const idx1 = ((y-1) * width + x) * 4;
                    const idx2 = ((y+1) * width + x) * 4;
                    const idx3 = (y * width + (x-1)) * 4;
                    const idx4 = (y * width + (x+1)) * 4;
                    
                    const gx = -1 * data[idx1] + 1 * data[idx2] + -2 * data[idx3] + 2 * data[idx4];
                    const gy = -1 * data[idx3] + 1 * data[idx4] + -2 * data[idx1] + 2 * data[idx2];
                    const g = Math.sqrt(gx*gx + gy*gy);
                    
                    edges[y * width + x] = g > threshold ? 255 : 0;
                }
            }
            
            return edges;
        }

        // „Ç®„ÉÉ„Ç∏ÈÅ©Áî®
        function applyEdges(edges, width, height) {
            const imgData = ctx.getImageData(0, 0, width, height);
            const data = imgData.data;
            
            for (let i = 0; i < width * height; i++) {
                const edge = edges[i];
                const idx = i * 4;
                
                if (edge === 255) {
                    data[idx] = 0;
                    data[idx+1] = 0;
                    data[idx+2] = 0;
                    data[idx+3] = 255;
                } else {
                    data[idx] = 255;
                    data[idx+1] = 255;
                    data[idx+2] = 255;
                    data[idx+3] = 0;
                }
            }
            
            ctx.putImageData(imgData, 0, 0);
        }

        // Á∑ö„ÅÆ„Çπ„É†„Éº„Ç∏„É≥„Ç∞
        function smoothLines() {
            ctx.filter = `blur(${settings.processingLevel * 0.5}px)`;
            const temp = ctx.getImageData(0, 0, canvas.width, canvas.height);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.putImageData(temp, 0, 0);
            ctx.filter = 'none';
        }

        // „Ç≥„É≥„Éà„É©„Çπ„ÉàÂº∑Ë™ø
        function enhanceContrast(data) {
            const factor = 1.2 + (settings.processingLevel * 0.2);
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, (data[i] - 128) * factor + 128));
                data[i+1] = Math.min(255, Math.max(0, (data[i+1] - 128) * factor + 128));
                data[i+2] = Math.min(255, Math.max(0, (data[i+2] - 128) * factor + 128));
            }
        }

        // „Åº„Åã„ÅóÈÅ©Áî®
        function applyBlur() {
            ctx.filter = `blur(${settings.processingLevel * 0.5}px)`;
            const temp = ctx.getImageData(0, 0, canvas.width, canvas.height);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.putImageData(temp, 0, 0);
            ctx.filter = 'none';
        }

        // „Ç´„É©„Éº„É¢„Éº„ÉâÈÅ©Áî®
        function applyColorMode() {
            if (settings.colorMode === 'original') return;
            
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                if (settings.colorMode === 'grayscale') {
                    const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                    data[i] = avg;
                    data[i+1] = avg;
                    data[i+2] = avg;
                } else if (settings.colorMode === 'highContrast') {
                    const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                    const val = avg > 128 ? 255 : 0;
                    data[i] = val;
                    data[i+1] = val;
                    data[i+2] = val;
                }
            }
            
            ctx.putImageData(imgData, 0, 0);
        }

        // „ÉÜ„ÇØ„Çπ„ÉÅ„É£ÈÅ©Áî®
        function applyTexture() {
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;
            
            if (settings.textureMode === 'sketch') {
                // „Çπ„Ç±„ÉÉ„ÉÅÈ¢®„ÉÜ„ÇØ„Çπ„ÉÅ„É£
                for (let y = 0; y < canvas.height; y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        const idx = (y * canvas.width + x) * 4;
                        
                        if (data[idx] < 100 && data[idx+1] < 100 && data[idx+2] < 100 && data[idx+3] > 0) {
                            const noise = Math.random() * 30;
                            data[idx] = Math.min(255, data[idx] + noise);
                            data[idx+1] = Math.min(255, data[idx+1] + noise);
                            data[idx+2] = Math.min(255, data[idx+2] + noise);
                            
                            if (Math.random() > 0.85) {
                                data[idx+3] = Math.max(0, data[idx+3] - Math.random() * 100);
                            }
                        }
                    }
                }
            } else if (settings.textureMode === 'pencil') {
                // ÈâõÁ≠ÜÈ¢®„ÉÜ„ÇØ„Çπ„ÉÅ„É£
                for (let i = 0; i < data.length; i += 4) {
                    if (data[i] < 100 && data[i+1] < 100 && data[i+2] < 100) {
                        const variance = Math.random() * 20 - 10;
                        data[i] = Math.max(0, Math.min(255, data[i] + variance));
                        data[i+1] = Math.max(0, Math.min(255, data[i+1] + variance));
                        data[i+2] = Math.max(0, Math.min(255, data[i+2] + variance));
                    }
                }
            }
            
            ctx.putImageData(imgData, 0, 0);
        }

        // Âá∫ÂäõÁîüÊàê
        function generateOutput() {
            const format = settings.outputFormat === 'webp' ? 'image/webp' : 'image/png';
            const quality = settings.outputFormat === 'webp' ? 0.8 : 1.0;
            
            if (settings.outputFormat === 'svg' && settings.outputType === 'vector') {
                generateSVG();
            } else {
                processedImage = canvas.toDataURL(format, quality);
                displayResult();
            }
        }

        // SVGÁîüÊàêÔºàÁ∞°ÊòìÁâàÔºâ
        function generateSVG() {
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;
            
            let svgContent = `<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}" viewBox="0 0 ${canvas.width} ${canvas.height}">`;
            
            // Èªí„ÅÑ„Éî„ÇØ„Çª„É´„ÇíÂ∞è„Åï„Å™ÂÜÜ„Å®„Åó„Å¶ÊèèÁîªÔºàÁ∞°ÊòìÁâàÔºâ
            for (let y = 0; y < canvas.height; y += 2) {
                for (let x = 0; x < canvas.width; x += 2) {
                    const idx = (y * canvas.width + x) * 4;
                    if (data[idx] < 50 && data[idx+1] < 50 && data[idx+2] < 50 && data[idx+3] > 200) {
                        svgContent += `<circle cx="${x}" cy="${y}" r="0.5" fill="black"/>`;
                    }
                }
            }
            
            svgContent += `</svg>`;
            
            const svgBlob = new Blob([svgContent], {type: 'image/svg+xml'});
            const reader = new FileReader();
            reader.onloadend = () => {
                processedImage = reader.result;
                displayResult();
            };
            reader.readAsDataURL(svgBlob);
        }

        // ÁµêÊûúË°®Á§∫
        function displayResult() {
            processedPreview.innerHTML = `<img src="${processedImage}" alt="Processed sketch" class="preview-image">`;
            downloadBtn.classList.remove('hidden');
        }

        // „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂá¶ÁêÜ
        function downloadImage() {
            if (!processedImage) return;
            
            try {
                const link = document.createElement('a');
                link.href = processedImage;
                
                const extension = settings.outputFormat === 'svg' ? 'svg' : 
                                 settings.outputFormat === 'webp' ? 'webp' : 'png';
                link.download = `digitized_${settings.outputType}_sketch.${extension}`;
                
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error("„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Ç®„É©„Éº:", error);
                alert("„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            }
        }
    </script>
</body>
</html>